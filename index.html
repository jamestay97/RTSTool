Here is the complete, updated HTML code. I have applied the necessary defensive checks (`(license.carriers || [])`) in the three critical functions (`performSearch`, `displaySearchResults`, and `loadUserLicenses`) to prevent the "Cannot read properties of undefined (reading 'toLowerCase')" error when licenses are missing carrier data.

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Insurance License Data Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .bubble { cursor:pointer; display:inline-block; padding:0.5rem 1rem; margin:0.25rem; border-radius:9999px; background:#4B5563; color:white; transition:0.2s;}
    .bubble.selected { background:#06B6D4; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    .search-highlight { background-color: #FACC15; color: #000; padding:0.1rem 0.25rem; border-radius:0.25rem;}
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; }
    .modal-content { background:#374151; border-radius:12px; max-width:600px; width:95%; max-height:90vh; overflow-y:auto; padding:1.5rem; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <div id="loading-screen" class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="border-4 border-t-cyan-400 rounded-full w-10 h-10 animate-spin mb-3"></div>
    <p class="text-lg">Loading...</p>
  </div>

  <div id="auth-screen" class="hidden text-center mt-10 px-4">
    <h2 class="text-3xl font-bold text-cyan-400 mb-4">Login</h2>
    <form id="login-form" class="space-y-3 max-w-sm mx-auto">
      <input id="login-email" type="email" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Email" required />
      <input id="login-password" type="password" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Password" required />
      <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 py-2 rounded">Login</button>
      <button type="button" id="show-forgot-password" class="w-full text-sm text-gray-400 hover:text-cyan-400 text-right underline p-1">
        Forgot Password?
      </button>
      </form>
    <p class="mt-4 text-gray-400">Don't have an account? <button id="show-register" class="text-cyan-400 underline">Register</button></p>

    <form id="register-form" class="hidden space-y-3 max-w-sm mx-auto mt-4">
      <input id="register-firstname" type="text" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="First Name" required />
      <input id="register-lastname" type="text" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Last Name" required />
      <input id="register-email" type="email" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Email" required />
      <input id="register-npn" type="text" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="NPN" required />
      <input id="register-extension" type="text" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Extension" required />
      <input id="register-password" type="password" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Password" required />
      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded">Register</button>
      <button type="button" id="cancel-register" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded">Cancel</button>
    </form>
  </div>

  <div id="dashboard" class="hidden p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Welcome, <span id="user-name" class="text-cyan-300"></span></h1>
      <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Logout</button>
    </div>
    
    <div id="nav-buttons" class="mt-6 space-x-2">
      <button class="tab-btn bg-cyan-600 px-3 py-1 rounded" data-tab="search">Search</button>
      <button class="tab-btn bg-gray-700 px-3 py-1 rounded" data-tab="licenses">My Licenses</button>
      <button class="tab-btn bg-gray-700 px-3 py-1 rounded hidden" data-tab="admin" id="admin-tab-btn">Admin</button>
    </div>

    <div id="search-tab" class="tab-panel mt-4">
      <div class="flex gap-2 mb-4">
        <input type="text" id="search-input" class="flex-1 p-2 rounded bg-gray-800 border border-gray-700" placeholder="Search by state, carrier, email, NPN, or name">
        <button id="search-btn" class="bg-cyan-600 hover:bg-cyan-700 py-2 px-4 rounded">Search</button>
      </div>
      <div id="search-results" class="mt-4 space-y-4"></div>
    </div>

    <div id="licenses-tab" class="tab-panel hidden mt-4">
      <button id="add-license-btn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded mb-4">Add License</button>
      <div id="licenses-container" class="space-y-3"></div>
    </div>

    <div id="admin-tab" class="tab-panel hidden mt-4">
      <h2 class="text-xl font-bold mb-4">Admin Panel</h2>
      
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">User Management</h3>
        <button id="refresh-users-btn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded mb-3">
          <i class="fas fa-sync-alt mr-1"></i>Refresh Users
        </button>
        <div id="users-list" class="space-y-3"></div>
      </div>
      
      <div>
        <h3 class="text-lg font-semibold mb-3">Carrier Management</h3>
        <div class="flex gap-2 mb-3">
          <input type="text" id="new-carrier-input" placeholder="New Carrier Name" class="flex-1 p-2 rounded bg-gray-800 border border-gray-700">
          <button id="add-carrier-btn" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded">Add Carrier</button>
        </div>
        <div id="carriers-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <div id="add-license-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold" id="add-license-title">Add New License</h3>
        <button id="close-add-license-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <form id="add-license-form" class="space-y-4">
        <div>
          <label class="block mb-2">Select States</label>
          <div id="add-license-states" class="bg-gray-800 p-3 rounded max-h-40 overflow-y-auto"></div>
        </div>
        <div>
          <label class="block mb-2">Select Carriers</label>
          <div id="carriers-container" class="bg-gray-800 p-3 rounded max-h-40 overflow-y-auto"></div>
        </div>
        <div>
          <label class="block mb-2">Expiration Date</label>
          <input type="date" id="license-expiration" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancel-add-license" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded">Cancel</button>
          <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded">Add License</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-user-licenses-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold" id="edit-user-title">Edit User Licenses</h3>
        <button id="close-edit-user-licenses-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="user-licenses-container" class="space-y-3 mb-4 max-h-60 overflow-y-auto"></div>
      <button id="add-license-for-user-btn" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded mb-4">
        <i class="fas fa-plus mr-2"></i>Add License for User
      </button>
      <div class="flex justify-end">
        <button id="close-edit-user-modal" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded">Close</button>
      </div>
    </div>
  </div>
  
  <div id="password-reset-email-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Request Password Reset Code</h3>
        <button id="close-reset-email-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      
      <form id="request-otp-form" class="space-y-4">
        <p class="text-gray-300">Enter the email associated with your account. We'll send you a one-time code to reset your password.</p>
        <input type="email" id="request-otp-email" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Your Email" required />
        <div class="flex justify-end gap-2">
          <button type="button" id="cancel-request-otp" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded">Cancel</button>
          <button type="submit" id="send-otp-button" class="bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded">Send Reset Code</button>
        </div>
      </form>
    </div>
  </div>

  <div id="password-reset-otp-modal" class="modal">
    <div class="modal-content">
      <div id="reset-password-container" class="mx-auto bg-gray-700 rounded-lg shadow-xl fade-in">
          <h2 class="text-2xl font-bold text-teal-400 mb-6 text-center">Reset Your Password</h2>
          
          <div id="otp-request-message" class="mb-4 p-3 bg-blue-600/50 text-white rounded-md">
              <p>A one-time code has been sent to your email address. Please enter the code, your email, and a new password below.</p>
          </div>

          <form id="otp-reset-form" onsubmit="handleOtpPasswordReset(event)">
              
              <div class="mb-4">
                  <label for="reset-email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                  <input type="email" id="reset-email" required readonly
                         class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-800 text-white placeholder-gray-500 focus:ring-teal-500 focus:border-teal-500 cursor-not-allowed">
              </div>

              <div class="mb-4">
                  <label for="reset-otp-code" class="block text-sm font-medium text-gray-300 mb-1">One-Time Code (from Email)</label>
                  <input type="text" id="reset-otp-code" required maxlength="6"
                         class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-800 text-white placeholder-gray-500 focus:ring-teal-500 focus:border-teal-500">
              </div>

              <div class="mb-4">
                  <label for="new-password" class="block text-sm font-medium text-gray-300 mb-1">New Password</label>
                  <input type="password" id="new-password" required minlength="6"
                         class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-800 text-white placeholder-gray-500 focus:ring-teal-500 focus:border-teal-500">
              </div>
              
              <div class="mb-6">
                  <label for="confirm-password" class="block text-sm font-medium text-gray-300 mb-1">Confirm New Password</label>
                  <input type="password" id="confirm-password" required minlength="6"
                         class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-800 text-white placeholder-gray-500 focus:ring-teal-500 focus:border-teal-500">
              </div>

              <button type="submit" id="reset-submit-button"
                      class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out">
                  Reset Password
              </button>
          </form>
          
          <p class="mt-4 text-center text-sm text-gray-400">
              <a href="#" onclick="closeOtpModal(); showLogin();" class="font-medium text-teal-400 hover:text-teal-300">
                  Back to Login
              </a>
          </p>
      </div>
    </div>
  </div>
  
  <script>
// ------------------- Supabase -------------------
const SUPABASE_URL = "https://sdkprilrlnfuqkotwfyd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNka3ByaWxybG5mdXFrb3R3ZnlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDA5MTksImV4cCI6MjA3NTQ3NjkxOX0.2E1jqwtXv03Jtc3nN1sRS3ZTIm4N02ftoX1G5NWef10";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ------------------- States Data -------------------
const STATES_DATA = [
  { name: "Alabama", abbreviation: "AL" }, { name: "Alaska", abbreviation: "AK" }, { name: "Arizona", abbreviation: "AZ" },
  { name: "Arkansas", abbreviation: "AR" }, { name: "California", abbreviation: "CA" }, { name: "Colorado", abbreviation: "CO" },
  { name: "Connecticut", abbreviation: "CT" }, { name: "Delaware", abbreviation: "DE" }, { name: "Florida", abbreviation: "FL" },
  { name: "Georgia", abbreviation: "GA" }, { name: "Hawaii", abbreviation: "HI" }, { name: "Idaho", abbreviation: "ID" },
  { name: "Illinois", abbreviation: "IL" }, { name: "Indiana", abbreviation: "IN" }, { name: "Iowa", abbreviation: "IA" },
  { name: "Kansas", abbreviation: "KS" }, { name: "Kentucky", abbreviation: "KY" }, { name: "Louisiana", abbreviation: "LA" },
  { name: "Maine", abbreviation: "ME" }, { name: "Maryland", abbreviation: "MD" }, { name: "Massachusetts", abbreviation: "MA" },
  { name: "Michigan", abbreviation: "MI" }, { name: "Minnesota", abbreviation: "MN" }, { name: "Mississippi", abbreviation: "MS" },
  { name: "Missouri", abbreviation: "MO" }, { name: "Montana", abbreviation: "MT" }, { name: "Nebraska", abbreviation: "NE" },
  { name: "Nevada", abbreviation: "NV" }, { name: "New Hampshire", abbreviation: "NH" }, { name: "New Jersey", abbreviation: "NJ" },
  { name: "New Mexico", abbreviation: "NM" }, { name: "New York", abbreviation: "NY" }, { name: "North Carolina", abbreviation: "NC" },
  { name: "North Dakota", abbreviation: "ND" }, { name: "Ohio", abbreviation: "OH" }, { name: "Oklahoma", abbreviation: "OK" },
  { name: "Oregon", abbreviation: "OR" }, { name: "Pennsylvania", abbreviation: "PA" }, { name: "Rhode Island", abbreviation: "RI" },
  { name: "South Carolina", abbreviation: "SC" }, { name: "South Dakota", abbreviation: "SD" }, { name: "Tennessee", abbreviation: "TN" },
  { name: "Texas", abbreviation: "TX" }, { name: "Utah", abbreviation: "UT" }, { name: "Vermont", abbreviation: "VT" },
  { name: "Virginia", abbreviation: "VA" }, { name: "Washington", abbreviation: "WA" }, { name: "West Virginia", abbreviation: "WV" },
  { name: "Wisconsin", abbreviation: "WI" }, { name: "Wyoming", abbreviation: "WY" }
];

// ------------------- App State -------------------
let currentUser = null;
let allUsers = [];
let carriers = [];
let currentEditingUserId = null;

// ------------------- Utility Functions -------------------
function escapeHtml(text) { 
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-2xl z-50 fade-in ${
    type === 'success' ? 'bg-green-600' : 
    type === 'error' ? 'bg-red-600' : 
    type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
  }`;
  notification.innerHTML = `
    <div class="flex items-center">
      <i class="fas ${
        type === 'success' ? 'fa-check' : 
        type === 'error' ? 'fa-exclamation-triangle' : 
        type === 'warning' ? 'fa-exclamation' : 'fa-info'
      } mr-2"></i>
      <span>${escapeHtml(message)}</span>
    </div>
  `;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3500);
}

function showAuthScreen() {
  document.getElementById('loading-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('auth-screen').classList.remove('hidden');
}

async function showDashboard() {
  document.getElementById('loading-screen').classList.add('hidden');
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('user-name').textContent = currentUser.name;
  
  // Show admin tab ONLY if user is actually an admin
  const adminTabBtn = document.getElementById('admin-tab-btn');
  if (currentUser.is_admin === true) {
    adminTabBtn.classList.remove('hidden');
    console.log('Admin access granted for:', currentUser.name);
  } else {
    adminTabBtn.classList.add('hidden');
    console.log('Regular user access for:', currentUser.name);
  }
  
  // Load fresh data
  await loadAllUsers();
  await loadCarriers();
  loadUserLicenses();
}

function showTab(tabName) {
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.add('hidden');
  });
  
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('bg-cyan-600');
    btn.classList.add('bg-gray-700');
  });
  
  document.getElementById(`${tabName}-tab`).classList.remove('hidden');
  document.querySelector(`[data-tab="${tabName}"]`).classList.remove('bg-gray-700');
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-cyan-600');
  
  // Only load admin panel if user is actually an admin
  if (tabName === 'admin') {
    if (!currentUser.is_admin) {
      showNotification('Access denied: Admin privileges required', 'error');
      showTab('search');
      return;
    }
    loadAdminPanel();
  }
}

function showLogin() {
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('register-form').classList.add('hidden');
}


// NEW OTP Password Reset Functions
function openEmailModal() {
  document.getElementById('password-reset-email-modal').style.display = 'flex';
}

function closeEmailModal() {
  document.getElementById('password-reset-email-modal').style.display = 'none';
  document.getElementById('request-otp-form').reset();
}

function openOtpModal(email) {
  document.getElementById('password-reset-otp-modal').style.display = 'flex';
  document.getElementById('reset-email').value = email; // Pre-fill email
}

function closeOtpModal() {
  document.getElementById('password-reset-otp-modal').style.display = 'none';
  document.getElementById('otp-reset-form').reset();
}


// ------------------- Event Listeners -------------------
document.addEventListener('DOMContentLoaded', initApp);

document.getElementById('show-register').addEventListener('click', () => {
  document.getElementById('login-form').classList.add('hidden');
  document.getElementById('register-form').classList.remove('hidden');
});

document.getElementById('cancel-register').addEventListener('click', () => {
  document.getElementById('register-form').classList.add('hidden');
  document.getElementById('login-form').classList.remove('hidden');
});

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => showTab(btn.dataset.tab));
});

document.getElementById('close-add-license-modal').addEventListener('click', closeAddLicenseModal);
document.getElementById('cancel-add-license').addEventListener('click', closeAddLicenseModal);
document.getElementById('add-license-modal').addEventListener('click', (e) => {
  if (e.target.id === 'add-license-modal') closeAddLicenseModal();
});

document.getElementById('close-edit-user-licenses-modal').addEventListener('click', closeEditUserLicensesModal);
document.getElementById('close-edit-user-modal').addEventListener('click', closeEditUserLicensesModal);
document.getElementById('edit-user-licenses-modal').addEventListener('click', (e) => {
  if (e.target.id === 'edit-user-licenses-modal') closeEditUserLicensesModal();
});

// NEW: Forgot Password Event Listeners (OTP Flow)
document.getElementById('show-forgot-password').addEventListener('click', openEmailModal);

document.getElementById('close-reset-email-modal').addEventListener('click', closeEmailModal);
document.getElementById('cancel-request-otp').addEventListener('click', closeEmailModal);
document.getElementById('password-reset-email-modal').addEventListener('click', (e) => {
  if (e.target.id === 'password-reset-email-modal') closeEmailModal();
});

document.getElementById('password-reset-otp-modal').addEventListener('click', (e) => {
  // Only close if clicking the backdrop, not the modal content
  if (e.target.id === 'password-reset-otp-modal') closeOtpModal(); 
});
// END NEW Event Listeners


// ------------------- App Init (CLEANED UP) -------------------
async function initApp() {
  // Removed URL hash check for old recovery link flow

  try {
    const savedUserId = localStorage.getItem('currentUserId');
    if (savedUserId) {
      // Check if Supabase has a session and if the user data exists in the custom table
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (session && !sessionError) {
          const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', savedUserId)
            .single();
          
          if (!error && user) {
            currentUser = user;
            await showDashboard();
            return;
          }
      }
    }
    showAuthScreen();
  } catch(e) {
    console.error('Init error:', e);
    showAuthScreen();
  }
}

// ------------------- Login (SECURELY MODIFIED) -------------------
document.getElementById('login-form').addEventListener('submit', async e => {
  e.preventDefault();
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value.trim();
  
  if (!email || !password) {
    showNotification('Enter email and password', 'error');
    return;
  }
  
  try {
    // 1. Authenticate with Supabase Auth (Secure Check against Hashed Password)
    const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
        email: email,
        password: password,
    });

    if (authError) throw authError;
    if (!authData.user) throw new Error("Authentication failed. Invalid email or password.");

    // 2. Fetch user details from the custom 'users' table using the secure auth ID
    const { data: users, error: dbError } = await supabase
      .from('users')
      .select('*')
      .eq('id', authData.user.id)
      .single(); 

    if (dbError) throw dbError;
    
    if (users) {
      currentUser = users; // The single user object
      localStorage.setItem('currentUserId', currentUser.id);
      await showDashboard();
      showNotification('Login successful!', 'success');
    } else {
      // The user exists in Supabase Auth but not in the custom table (rare case)
      showNotification('User data incomplete. Please contact support.', 'error');
    }
  } catch(err) {
    console.error(err);
    showNotification('Login failed: ' + err.message, 'error');
  }
});

// ------------------- Register (SECURELY MODIFIED) -------------------
document.getElementById('register-form').addEventListener('submit', async e => {
  e.preventDefault();
  const firstname = document.getElementById('register-firstname').value.trim();
  const lastname = document.getElementById('register-lastname').value.trim();
  const email = document.getElementById('register-email').value.trim();
  const npn = document.getElementById('register-npn').value.trim();
  const extension = document.getElementById('register-extension').value.trim();
  const password = document.getElementById('register-password').value.trim();
  
  if (!firstname || !lastname || !email || !npn || !extension || !password) {
    showNotification('Fill all fields', 'error');
    return;
  }
  
  try {
    // 1. Create user in Supabase Auth (This handles password hashing securely)
    const { data: authData, error: authError } = await supabase.auth.signUp({
        email: email,
        password: password,
        options: {
            data: {
                full_name: `${firstname} ${lastname}`
            },
            // Note: Email confirmation link is sent here. No password reset link.
        }
    });

    if (authError) throw authError;

    // 2. Create user in your custom 'users' table (NO PASSWORD FIELD INSERTED)
    const newUser = {
      id: authData.user.id, // Use the ID from Supabase Auth
      firstname,
      lastname,
      name: `${firstname} ${lastname}`,
      email,
      npn,
      extension,
      // Removed: password field to prevent plaintext storage ðŸ›‘
      licenses: [],
      is_admin: false
    };
    
    const { data: createdUser, error: dbError } = await supabase
      .from('users')
      .insert([newUser])
      .select()
      .single();
    
    if (dbError) throw dbError;
    
    showNotification('Registration successful! Check your email to confirm, then log in.', 'success');
    document.getElementById('register-form').reset();
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('login-form').classList.remove('hidden');
  } catch(err) {
    console.error(err);
    showNotification('Registration failed: ' + err.message, 'error');
  }
});

// ------------------- Logout -------------------
document.getElementById('logout-btn').addEventListener('click', async () => {
  await supabase.auth.signOut(); // Sign out of Supabase Auth session
  currentUser = null;
  localStorage.removeItem('currentUserId');
  showAuthScreen();
  showNotification('Logged out', 'info');
});

// ------------------- Forgot Password - Step 1: Send OTP Email -------------------
document.getElementById('request-otp-form').addEventListener('submit', async e => {
  e.preventDefault();
  const email = document.getElementById('request-otp-email').value.trim();
  const sendButton = document.getElementById('send-otp-button');
  
  sendButton.disabled = true;
  sendButton.textContent = 'Sending...';

  try {
    // Supabase sends a one-time code (OTP) via email
    const { error } = await supabase.auth.signInWithOtp({
      email: email,
      options: {
        shouldCreateUser: false, 
        emailRedirectTo: null, // Forces sending a code instead of a magic link
        data: { channel: 'email' } // Explicitly requests the email channel OTP
      }
    });
    
    if (error) throw error;
    
    closeEmailModal();
    openOtpModal(email);
    showNotification('One-time code sent to your email! Check your inbox.', 'success');
  } catch(err) {
    console.error(err);
    showNotification('Error sending reset code: ' + err.message, 'error');
  } finally {
    sendButton.disabled = false;
    sendButton.textContent = 'Send Reset Code';
  }
});


// ------------------- Forgot Password - Step 2: Update Password using OTP (SECURELY MODIFIED) -------------------
async function handleOtpPasswordReset(event) {
    event.preventDefault();
    
    const email = document.getElementById('reset-email').value.trim();
    const code = document.getElementById('reset-otp-code').value.trim();
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const submitButton = document.getElementById('reset-submit-button');

    if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match.', 'error');
        return;
    }

    if (newPassword.length < 6) { 
      showNotification('Password must be at least 6 characters', 'error');
      return;
    }

    submitButton.disabled = true;
    submitButton.textContent = 'Resetting...';

    try {
        // 1. Verify the OTP code to sign the user in
        const { error: signInError, data: { user: authUser } } = await supabase.auth.verifyOtp({
            email,
            token: code,
            type: 'email', // Use 'email' for the code sent via signInWithOtp
        });

        if (signInError) throw signInError;
        if (!authUser) throw new Error("Verification successful but no user session established.");

        // 2. Update the password in Supabase Auth (Secure Hashing is done here)
        const { error: updateAuthError } = await supabase.auth.updateUser({
            password: newPassword
        });

        if (updateAuthError) throw updateAuthError;

        // 3. Removed update to custom 'users' table: The plaintext password is no longer stored or updated.
        
        showNotification('Password updated successfully! You can now log in.', 'success');
        
        closeOtpModal();
        showLogin();
        
    } catch (error) {
        console.error('Password Reset Error:', error);
        showNotification(error.message || 'An error occurred during password reset.', 'error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Reset Password';
    }
}
// END NEW OTP Logic

// ------------------- Load Users -------------------
async function loadAllUsers() {
  try {
    const { data: users, error } = await supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    allUsers = users || [];
    console.log('âœ… Loaded users:', allUsers.length);
  } catch(err) {
    console.error('Error loading users:', err);
    allUsers = [];
  }
}

// ------------------- Load Carriers -------------------
async function loadCarriers() {
  try {
    const { data: carrierData, error } = await supabase
      .from('carriers')
      .select('*')
      .order('name');
    
    if (error) throw error;
    
    if (carrierData && carrierData.length > 0) {
      carriers = carrierData.map(c => c.name);
    } else {
      // Initialize with default carriers if none exist
      const defaultCarriers = ["State Farm", "Allstate", "Geico", "Progressive", "Liberty Mutual"];
      for (const carrier of defaultCarriers) {
        await supabase.from('carriers').insert([{ name: carrier }]);
      }
      carriers = [...defaultCarriers];
    }
    console.log('âœ… Loaded carriers:', carriers);
  } catch(err) {
    console.error('Error loading carriers:', err);
    carriers = ["State Farm", "Allstate", "Geico", "Progressive", "Liberty Mutual"];
  }
}

// ------------------- License Management -------------------
document.getElementById('add-license-btn').addEventListener('click', openAddLicenseModal);
document.getElementById('add-license-form').addEventListener('submit', handleAddLicense);
document.getElementById('add-license-for-user-btn').addEventListener('click', openAddLicenseForUser);

async function openAddLicenseModal() {
  currentEditingUserId = null;
  document.getElementById('add-license-title').textContent = 'Add New License';
  await loadCarriers();
  populateStateBubbles();
  populateCarrierBubbles();
  document.getElementById('add-license-modal').style.display = 'flex';
}

async function openAddLicenseForUser() {
  if (!currentEditingUserId) {
    showNotification('No user selected', 'error');
    return;
  }
  
  const user = allUsers.find(u => u.id === currentEditingUserId);
  if (!user) {
    showNotification('User not found', 'error');
    return;
  }
  
  // Hide the current modal (agent's license list) without clearing the currentEditingUserId
  document.getElementById('edit-user-licenses-modal').style.display = 'none';

  await loadCarriers();
  populateStateBubbles();
  populateCarrierBubbles();
  document.getElementById('add-license-title').textContent = `Add License for ${user.name}`;
  document.getElementById('add-license-modal').style.display = 'flex';
}

function closeAddLicenseModal() {
  document.getElementById('add-license-modal').style.display = 'none';
  document.getElementById('add-license-form').reset();
  document.querySelectorAll('.bubble.selected').forEach(bubble => {
    bubble.classList.remove('selected');
  });
  // Clear the editing user ID when modal closes
  currentEditingUserId = null;
}

function populateStateBubbles() {
  const container = document.getElementById('add-license-states');
  container.innerHTML = '';
  
  STATES_DATA.forEach(state => {
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = `${state.name} (${state.abbreviation})`;
    bubble.dataset.value = state.abbreviation;
    bubble.addEventListener('click', () => {
      bubble.classList.toggle('selected');
    });
    container.appendChild(bubble);
  });
}

function populateCarrierBubbles() {
  const container = document.getElementById('carriers-container');
  container.innerHTML = '';
  
  carriers.forEach(carrier => {
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = carrier;
    bubble.dataset.value = carrier;
    bubble.addEventListener('click', () => {
      bubble.classList.toggle('selected');
    });
    container.appendChild(bubble);
  });
}

async function handleAddLicense(e) {
  e.preventDefault();
  
  const selectedStates = Array.from(document.querySelectorAll('#add-license-states .bubble.selected'))
    .map(bubble => bubble.dataset.value);
  const selectedCarriers = Array.from(document.querySelectorAll('#carriers-container .bubble.selected'))
    .map(bubble => bubble.dataset.value);
  const expiration = document.getElementById('license-expiration').value;
  
  if (selectedStates.length === 0) {
    showNotification('Please select at least one state', 'error');
    return;
  }
  
  if (selectedCarriers.length === 0) {
    showNotification('Please select at least one carrier', 'error');
    return;
  }
  
  try {
    let targetUserId = currentUser.id;
    let targetUser = currentUser;
    
    // Check if admin is editing another user
    if (currentEditingUserId) {
      console.log('Editing user:', currentEditingUserId);
      targetUserId = currentEditingUserId;
      const { data: freshUser, error: fetchError } = await supabase
        .from('users')
        .select('*')
        .eq('id', currentEditingUserId)
        .single();
      
      if (fetchError) {
        console.error('Error fetching user:', fetchError);
        throw fetchError;
      }
      targetUser = freshUser;
    }
    
    if (!targetUser) {
      showNotification('User not found', 'error');
      return;
    }
    
    let currentLicenses = targetUser.licenses || [];
    let licensesModified = false;
    let licensesAddedCount = 0;
    let carriersAddedCount = 0;
    
    // Use a map to simplify updates to existing licenses: State Abbreviation -> License Object
    const licenseMap = new Map(currentLicenses.map(l => [l.state, l]));

    selectedStates.forEach(state => {
      let existingLicense = licenseMap.get(state);

      if (existingLicense) {
        // Scenario: Existing State. Merge carriers.
        selectedCarriers.forEach(carrier => {
          // Use defensive check for existingLicense.carriers
          if (!(existingLicense.carriers || []).includes(carrier)) {
            existingLicense.carriers = existingLicense.carriers || []; // Ensure it's an array before pushing
            existingLicense.carriers.push(carrier);
            carriersAddedCount++;
            licensesModified = true;
          }
        });
        
        // Update expiration if a new one is provided
        if (expiration) {
          existingLicense.expiration = expiration;
          licensesModified = true;
        }

      } else {
        // Scenario: New State. Create new license entry.
        const newLicense = {
          state: state,
          carriers: [...selectedCarriers], // Copy the array
          expiration: expiration || ''
        };
        licenseMap.set(state, newLicense);
        licensesAddedCount++;
        licensesModified = true;
      }
    });
    
    // Reconstruct the updated licenses array from the map
    const updatedLicenses = Array.from(licenseMap.values());

    if (!licensesModified) {
      showNotification('No new licenses or carriers were added.', 'warning');
      closeAddLicenseModal();
      return;
    }
    
    console.log('Updating licenses for user ID:', targetUserId, 'New count:', updatedLicenses.length);
    
    const { error } = await supabase
      .from('users')
      .update({ licenses: updatedLicenses })
      .eq('id', targetUserId);
    
    if (error) {
      console.error('Error updating licenses:', error);
      throw error;
    }
    
    // Only update current user's data if they added to themselves
    if (targetUserId === currentUser.id) {
      currentUser.licenses = updatedLicenses;
      loadUserLicenses();
    }
    
    await loadAllUsers();
    
    // Store currentEditingUserId before closing the modal (as closing sets it to null)
    const editingIdAfterSuccess = currentEditingUserId;
    
    closeAddLicenseModal(); // This now clears currentEditingUserId
    
    const notificationMessage = [];
    if (licensesAddedCount > 0) {
        notificationMessage.push(`${licensesAddedCount} new state license(s)`);
    }
    if (carriersAddedCount > 0) {
        notificationMessage.push(`${carriersAddedCount} new carrier appointment(s)`);
    }
    
    showNotification(`Successfully added: ${notificationMessage.join(' and ')} to ${targetUser.name}!`, 'success');
    
    // If admin was editing another user, reopen their modal
    if (editingIdAfterSuccess) {
      setTimeout(() => {
        openEditUserLicenses(editingIdAfterSuccess);
        loadAdminPanel();
      }, 100);
    }
  } catch(error) {
    console.error('Error adding licenses:', error);
    showNotification('Error adding licenses: ' + error.message, 'error');
  }
}

function loadUserLicenses() {
  const container = document.getElementById('licenses-container');
  const licenses = currentUser.licenses || [];
  
  if (licenses.length === 0) {
    container.innerHTML = '<p class="text-gray-400 text-center py-4">No licenses found. Click "Add License" to get started.</p>';
    return;
  }
  
  let html = '';
  licenses.forEach((license, index) => {
    const state = STATES_DATA.find(s => s.abbreviation === license.state);
    const stateName = state ? state.name : license.state;
    
    // FIX APPLIED HERE: Use (license.carriers || []) to safely access carriers
    const carriersList = (license.carriers || []).join(', ');

    html += `
      <div class="bg-gray-800 p-4 rounded-lg">
        <div class="flex justify-between items-start">
          <div>
            <h4 class="text-lg font-semibold text-cyan-300">${escapeHtml(stateName)} (${escapeHtml(license.state)})</h4>
            <p class="text-gray-400 mt-1">Carriers: ${escapeHtml(carriersList)}</p>
            ${license.expiration ? `<p class="text-gray-400">Expires: ${escapeHtml(license.expiration)}</p>` : ''}
          </div>
          <button onclick="deleteLicense(${index})" class="text-red-400 hover:text-red-300">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function deleteLicense(licenseIndex) {
  if (!confirm('Are you sure you want to delete this license?')) return;
  
  try {
    const updatedLicenses = currentUser.licenses.filter((_, index) => index !== licenseIndex);
    
    const { error } = await supabase
      .from('users')
      .update({ licenses: updatedLicenses })
      .eq('id', currentUser.id);
    
    if (error) throw error;
    
    currentUser.licenses = updatedLicenses;
    loadUserLicenses();
    showNotification('License deleted successfully', 'success');
  } catch(error) {
    console.error(error);
    showNotification('Error deleting license: ' + error.message, 'error');
  }
}

// ------------------- Admin License Management -------------------
async function openEditUserLicenses(userId) {
  currentEditingUserId = userId;
  
  // Fetch fresh user data
  const { data: user, error } = await supabase
    .from('users')
    .select('*')
    .eq('id', userId)
    .single();
  
  if (error || !user) {
    showNotification('User not found', 'error');
    return;
  }
  
  document.getElementById('edit-user-title').textContent = `Edit Licenses for ${escapeHtml(user.name)}`;
  
  const container = document.getElementById('user-licenses-container');
  container.innerHTML = '';
  
  const userLicenses = user.licenses || [];
  
  if (userLicenses.length === 0) {
    container.innerHTML = '<p class="text-gray-400 text-center py-4">No licenses found</p>';
  } else {
    userLicenses.forEach((license, index) => {
      const state = STATES_DATA.find(s => s.abbreviation === license.state);
      const stateName = state ? state.name : license.state;
      
      const licenseDiv = document.createElement('div');
      licenseDiv.className = 'bg-gray-800 p-4 rounded-lg';
      licenseDiv.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <h4 class="text-lg font-semibold text-cyan-300">${escapeHtml(stateName)} (${escapeHtml(license.state)})</h4>
            <p class="text-gray-400 text-sm">Carriers: ${escapeHtml((license.carriers || []).join(', '))}</p>
            ${license.expiration ? `<p class="text-gray-400 text-sm">Expires: ${escapeHtml(license.expiration)}</p>` : ''}
          </div>
          <button onclick="deleteUserLicense('${userId}', ${index})" class="text-red-400 hover:text-red-300">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      container.appendChild(licenseDiv);
    });
  }
  
  document.getElementById('edit-user-licenses-modal').style.display = 'flex';
}

async function deleteUserLicense(userId, licenseIndex) {
  if (!confirm('Are you sure you want to delete this license?')) return;
  
  try {
    const { data: user } = await supabase
      .from('users')
      .select('*')
      .eq('id', userId)
      .single();
    
    if (!user) {
      showNotification('User not found', 'error');
      return;
    }
    
    const updatedLicenses = user.licenses.filter((_, index) => index !== licenseIndex);
    
    const { error } = await supabase
      .from('users')
      .update({ licenses: updatedLicenses })
      .eq('id', userId);
    
    if (error) throw error;
    
    await loadAllUsers();
    openEditUserLicenses(userId);
    loadAdminPanel();
    
    showNotification('License deleted successfully', 'success');
  } catch(error) {
    console.error('Error deleting license:', error);
    showNotification('Error deleting license: ' + error.message, 'error');
  }
}

function closeEditUserLicensesModal() {
  document.getElementById('edit-user-licenses-modal').style.display = 'none';
  currentEditingUserId = null;
}

// ------------------- Search Functionality -------------------
document.getElementById('search-btn').addEventListener('click', performSearch);
document.getElementById('search-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') performSearch();
});

async function performSearch() {
  const query = document.getElementById('search-input').value.trim();
  if (!query) {
    showNotification('Please enter a search term', 'warning');
    return;
  }
  
  try {
    const { data: users, error } = await supabase.from('users').select('*');
    if (error) throw error;
    
    const searchTerm = query.toLowerCase();
    // This array will store objects like: { user: UserObject, licenses: FilteredLicensesArray }
    const finalResults = [];

    users.forEach(user => {
        const userLicenses = user.licenses || [];
        
        // 1. Check for Matches
        // MODIFIED: Agent name must now be an EXACT match of the full stored name
        const nameMatch = user.name && user.name.toLowerCase() === searchTerm; 
        // FIX APPLIED HERE: Use (user.email ?? '') and (user.npn ?? '') for defensive reading
        const identifierMatch = ((user.email ?? '').toLowerCase() === searchTerm) || ((user.npn ?? '').toLowerCase() === searchTerm);
        
        // 2. Identify Licenses that are an EXACT match for the search term
        const licenseMatches = userLicenses.filter(license => {
            const state = STATES_DATA.find(s => s.abbreviation === license.state);
            const stateName = state ? state.name.toLowerCase() : '';
            
            // EXACT MATCHING on State Abbreviation, Full State Name, or Carrier Name
            const stateExactMatch = license.state.toLowerCase() === searchTerm || stateName === searchTerm;
            // FIX APPLIED HERE: Use (license.carriers || []) to safely access carriers
            const carrierExactMatch = (license.carriers || []).some(carrier => carrier.toLowerCase() === searchTerm);
            
            return stateExactMatch || carrierExactMatch;
        });

        let licensesToDisplay = [];
        
        if (nameMatch || identifierMatch) {
            // Case 1: Agent-centric search (Name, Email, NPN). Show ALL licenses for context.
            licensesToDisplay = userLicenses;
        } else if (licenseMatches.length > 0) {
            // Case 2: License-centric search (State, Carrier). Show ONLY the matching licenses.
            licensesToDisplay = licenseMatches;
        }

        // 3. Final Check: Only include the user if a match was found in any category.
        if (nameMatch || identifierMatch || licenseMatches.length > 0) {
            finalResults.push({ user, licenses: licensesToDisplay });
        }
    });

    console.log('Search results:', finalResults.length, 'for query:', query);
    displaySearchResults(finalResults, query);
  } catch(error) {
    console.error(error);
    showNotification('Search failed: ' + error.message, 'error');
  }
}

function displaySearchResults(results, query) {
  const container = document.getElementById('search-results');
  
  if (results.length === 0) {
    container.innerHTML = '<p class="text-gray-400 text-center py-4">No results found</p>';
    return;
  }
  
  let html = `<p class="text-gray-400 mb-3">Found ${results.length} result(s)</p>`;
  
  results.forEach(result => {
    const user = result.user;
    const licenses = result.licenses; // **Using the pre-filtered list**
    
    html += `
      <div class="bg-gray-800 p-4 rounded-lg">
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="text-lg font-semibold text-cyan-300">${highlightMatch(escapeHtml(user.name), query)}</h3>
            <p class="text-gray-400">${highlightMatch(escapeHtml(user.email), query)} | NPN: ${highlightMatch(escapeHtml(user.npn), query)}</p>
            <p class="text-gray-400 text-sm">Extension: ${escapeHtml(user.extension || 'N/A')}</p>
          </div>
          <span class="${user.is_admin ? 'bg-red-600' : 'bg-green-600'} px-2 py-1 rounded text-xs">${user.is_admin ? 'Admin' : 'Agent'}</span>
        </div>
    `;
    
    if (licenses.length > 0) {
      licenses.forEach(license => {
        const state = STATES_DATA.find(s => s.abbreviation === license.state);
        const stateName = state ? state.name : license.state;
        
        html += `
          <div class="bg-gray-700 p-3 rounded mb-2">
            <h4 class="font-semibold">${highlightMatch(escapeHtml(stateName), query)} (${highlightMatch(escapeHtml(license.state), query)})</h4>
            <p class="text-gray-300 text-sm">Carriers: ${(license.carriers || []).map(carrier => highlightMatch(escapeHtml(carrier), query)).join(', ')}</p>
            ${license.expiration ? `<p class="text-gray-400 text-sm">Expires: ${escapeHtml(license.expiration)}</p>` : ''}
          </div>
        `;
      });
    } else {
      html += '<p class="text-gray-400 text-sm">No licenses matching this exact term.</p>';
    }
    
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function highlightMatch(text, query) {
  if (!query) return text;
  // Use a partial match regex for highlighting for a better user experience
  const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
  return text.replace(regex, '<span class="search-highlight">$1</span>');
}

// Helper to escape special regex characters
function escapeRegex(string) {
Â  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ------------------- Admin Functionality -------------------
document.getElementById('add-carrier-btn').addEventListener('click', addCarrier);
document.getElementById('refresh-users-btn').addEventListener('click', async () => {
  await loadAllUsers();
  loadAdminPanel();
  showNotification('Users refreshed', 'success');
});

async function loadAdminPanel() {
  // Double-check admin status
  if (!currentUser.is_admin) {
    showNotification('Access denied: Admin privileges required', 'error');
    showTab('search');
    return;
  }
  
  await loadAllUsers();
  await loadCarriers();
  
  // Load users list
  let usersHtml = '';
  allUsers.forEach(user => {
    const licenseCount = (user.licenses || []).length;
    const uniqueStates = new Set((user.licenses || []).map(l => l.state));
    const stateCount = uniqueStates.size;
    const isCurrentUser = user.id === currentUser.id;
    
    usersHtml += `
      <div class="bg-gray-800 p-4 rounded">
        <div class="flex justify-between items-start mb-3">
          <div>
            <h4 class="font-semibold text-cyan-300">${escapeHtml(user.name)} ${isCurrentUser ? '(You)' : ''}</h4>
            <p class="text-gray-400 text-sm">${escapeHtml(user.email)}</p>
            <p class="text-gray-400 text-sm">NPN: ${escapeHtml(user.npn)} | Ext: ${escapeHtml(user.extension)}</p>
          </div>
          <span class="${user.is_admin ? 'bg-red-600' : 'bg-green-600'} px-2 py-1 rounded text-xs">${user.is_admin ? 'Admin' : 'Agent'}</span>
        </div>
        <div class="grid grid-cols-2 gap-2 mb-3 text-center">
          <div class="bg-gray-700 p-2 rounded">
            <div class="text-xl font-bold text-cyan-400">${licenseCount}</div>
            <div class="text-xs text-gray-400">Licenses</div>
          </div>
          <div class="bg-gray-700 p-2 rounded">
            <div class="text-xl font-bold text-cyan-400">${stateCount}</div>
            <div class="text-xs text-gray-400">States</div>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="openEditUserLicenses('${user.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded text-sm">
            <i class="fas fa-edit mr-1"></i>Edit Licenses
          </button>
          ${!isCurrentUser ? `
            <button onclick="toggleAdminStatus('${user.id}', ${!user.is_admin})" class="flex-1 ${user.is_admin ? 'bg-green-600 hover:bg-green-700' : 'bg-purple-600 hover:bg-purple-700'} py-2 rounded text-sm">
              <i class="fas ${user.is_admin ? 'fa-user' : 'fa-crown'} mr-1"></i>${user.is_admin ? 'Remove Admin' : 'Make Admin'}
            </button>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  document.getElementById('users-list').innerHTML = usersHtml;
  
  // Load carriers list
  let carriersHtml = '';
  carriers.forEach(carrier => {
    carriersHtml += `
      <div class="flex justify-between items-center bg-gray-800 p-3 rounded">
        <span>${escapeHtml(carrier)}</span>
        <button onclick="removeCarrier('${escapeHtml(carrier)}')" class="text-red-400 hover:text-red-300">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
  });
  
  document.getElementById('carriers-list').innerHTML = carriersHtml;
}

async function toggleAdminStatus(userId, makeAdmin) {
  if (!confirm(`Are you sure you want to ${makeAdmin ? 'make this user an admin' : 'remove admin privileges'}?`)) return;
  
  try {
    const { error } = await supabase
      .from('users')
      .update({ is_admin: makeAdmin })
      .eq('id', userId);
    
    if (error) throw error;
    
    await loadAllUsers();
    loadAdminPanel();
    showNotification(`User ${makeAdmin ? 'promoted to admin' : 'demoted to agent'} successfully`, 'success');
  } catch(error) {
    console.error(error);
    showNotification('Error updating user: ' + error.message, 'error');
  }
}

async function addCarrier() {
  const input = document.getElementById('new-carrier-input');
  const carrierName = input.value.trim();
  
  if (!carrierName) {
    showNotification('Please enter a carrier name', 'error');
    return;
  }
  
  if (carriers.includes(carrierName)) {
    showNotification('Carrier already exists', 'warning');
    return;
  }
  
  try {
    const { error } = await supabase
      .from('carriers')
      .insert([{ name: carrierName }]);
    
    if (error) throw error;
    
    carriers.push(carrierName);
    input.value = '';
    
    showNotification(`Added carrier: ${carrierName}`, 'success');
    loadAdminPanel();
  } catch(error) {
    console.error(error);
    showNotification('Error adding carrier: ' + error.message, 'error');
  }
}

async function removeCarrier(carrierName) {
  if (!confirm(`Remove carrier "${carrierName}"?`)) return;
  
  try {
    const { error } = await supabase
      .from('carriers')
      .delete()
      .eq('name', carrierName);
    
    if (error) throw error;
    
    carriers = carriers.filter(c => c !== carrierName);
    showNotification(`Removed carrier: ${carrierName}`, 'success');
    loadAdminPanel();
  } catch(error) {
    console.error(error);
    showNotification('Error removing carrier: ' + error.message, 'error');
  }
}

// Make functions available globally
window.deleteLicense = deleteLicense;
window.deleteUserLicense = deleteUserLicense;
window.toggleAdminStatus = toggleAdminStatus;
window.removeCarrier = removeCarrier;
window.openEditUserLicenses = openEditUserLicenses;
window.handleOtpPasswordReset = handleOtpPasswordReset;
window.closeOtpModal = closeOtpModal;
window.showLogin = showLogin;
</script>
<footer class="text-center text-gray-500 text-xs py-4 mt-8 border-t border-gray-700">
  &copy; 2025 [James Taylor]. All Rights Reserved.
</footer>
</body>
</html>
```
