<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Insurance License Data Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .bubble { cursor:pointer; display:inline-block; padding:0.5rem 1rem; margin:0.25rem; border-radius:9999px; background:#4B5563; color:white; transition:0.2s;}
    .bubble.selected { background:#06B6D4; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    .search-highlight { background-color: #FACC15; color: #000; padding:0.1rem 0.25rem; border-radius:0.25rem;}
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;}
    .modal.show { display:flex; }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen">
  <div id="app" class="p-4 md:p-8">

    <!-- Header and Navigation -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-700 pb-4">
      <h1 class="text-3xl font-extrabold text-cyan-400">License Manager</h1>
      <div class="flex items-center space-x-4 mt-3 md:mt-0">
        <button id="admin-panel-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded transition duration-200">
          <i class="fas fa-user-shield mr-2"></i>Admin Panel
        </button>
        <button id="logout-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded transition duration-200">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
    </header>

    <!-- Main Content Area -->
    <div id="main-content" class="fade-in">

      <!-- User Dashboard (Default View) -->
      <section id="user-dashboard">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
          <h2 class="text-2xl font-bold text-gray-200 mb-3">Welcome, <span id="user-name"></span></h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-700 p-4 rounded-lg">
              <p class="text-sm text-gray-400">NPN</p>
              <p id="user-npn" class="text-xl font-bold text-cyan-300"></p>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
              <p class="text-sm text-gray-400">Extension</p>
              <p id="user-extension" class="text-xl font-bold text-cyan-300"></p>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-400">Total Licenses</p>
                    <p id="total-licenses" class="text-xl font-bold text-cyan-300">0</p>
                </div>
                <button onclick="openLicenseModal()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                    <i class="fas fa-plus mr-1"></i>Add License
                </button>
            </div>
          </div>
        </div>

        <!-- My Licenses List -->
        <h3 class="text-xl font-bold text-gray-200 mb-4">My Licenses</h3>
        <div id="my-licenses-container" class="space-y-4">
          <!-- Licenses will be rendered here -->
          <p class="text-gray-400 text-center p-8" id="loading-licenses">Loading licenses...</p>
        </div>
      </section>

      <!-- Admin Panel View -->
      <section id="admin-panel" class="hidden fade-in">
        <h2 class="text-3xl font-bold text-red-400 mb-6 border-b border-gray-700 pb-3">Administrator Dashboard</h2>
        
        <!-- Search and Refresh -->
        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <input type="text" id="user-search" placeholder="Search Agents by Name, Email, or NPN" class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-red-500 focus:border-red-500" />
            <button id="refresh-users-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Users
            </button>
        </div>

        <!-- Carrier Management -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h3 class="text-xl font-bold text-gray-200 mb-4">Carrier Management</h3>
            <div id="carriers-list" class="flex flex-wrap mb-4">
                <!-- Carriers will be listed here -->
            </div>
            <div class="flex space-x-3">
                <input type="text" id="new-carrier-name" placeholder="New Carrier Name" class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600" />
                <button id="add-carrier-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    <i class="fas fa-plus mr-2"></i>Add Carrier
                </button>
            </div>
        </div>

        <!-- Agents List -->
        <h3 class="text-xl font-bold text-gray-200 mb-4">Agent License Data</h3>
        <div id="all-users-container" class="space-y-4">
          <!-- Users and their licenses will be rendered here -->
          <p class="text-gray-400 text-center p-8">Searching for agents...</p>
        </div>
      </section>

    </div>
  </div>

  <!-- License Modal -->
  <div id="license-modal" class="modal">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-lg shadow-2xl relative fade-in">
      <button onclick="closeModal('license-modal')" class="absolute top-3 right-3 text-gray-500 hover:text-white transition duration-150">
        <i class="fas fa-times text-2xl"></i>
      </button>
      <h3 id="license-modal-title" class="text-2xl font-bold text-cyan-400 mb-4">Add License</h3>
      
      <!-- Hidden field to store the user ID being edited (for admin use) -->
      <input type="hidden" id="license-user-id" value=""> 

      <form id="license-form" class="space-y-4">
        <div>
          <label for="license-state" class="block text-sm font-medium text-gray-300">State</label>
          <select id="license-state" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500">
            <option value="">Select State</option>
            <!-- State options will be populated by JS -->
          </select>
        </div>
        <div>
          <label for="license-expiration" class="block text-sm font-medium text-gray-300">Expiration Date (Optional)</label>
          <input type="date" id="license-expiration" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300">Carriers</label>
          <div id="license-carriers" class="flex flex-wrap bg-gray-700 p-3 rounded-lg border border-gray-600">
            <!-- Carrier bubbles will be populated by JS -->
            <p class="text-gray-400 text-sm">Loading carriers...</p>
          </div>
        </div>
        <input type="hidden" id="license-index" />
        <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-3 rounded-lg transition duration-200">
          Save License
        </button>
      </form>
    </div>
  </div>

  <!-- Notification Modal -->
  <div id="notification-modal" class="modal pointer-events-none">
    <div id="notification-content" class="bg-green-600 p-4 rounded-lg shadow-2xl text-white text-center text-lg absolute top-4 fade-in">
      Notification Message
    </div>
  </div>

  <!-- Confirmation Modal (Replaces window.confirm) -->
  <div id="confirm-modal" class="modal">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-sm shadow-2xl relative fade-in">
      <h3 class="text-xl font-bold text-red-400 mb-4">Confirm Action</h3>
      <p id="confirm-message" class="text-gray-300 mb-6">Are you sure you want to perform this action?</p>
      <div class="flex justify-end space-x-3">
        <button id="confirm-cancel" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
          Cancel
        </button>
        <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
          Confirm
        </button>
      </div>
    </div>
  </div>

  <!-- Login/Register Modal -->
  <div id="auth-modal" class="modal show">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-sm shadow-2xl relative fade-in">
      <h3 class="text-2xl font-bold text-cyan-400 mb-4">Login or Register</h3>
      <form id="auth-form" class="space-y-4">
        <div>
          <input type="text" id="auth-npn" placeholder="NPN (Required)" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500" />
        </div>
        <div>
          <input type="text" id="auth-extension" placeholder="Extension (Required)" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500" />
        </div>
        <div>
          <input type="text" id="auth-name" placeholder="Full Name (Register Only)" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500" />
        </div>
        <div>
          <input type="email" id="auth-email" placeholder="Email (Register Only)" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500" />
        </div>
        <div class="flex space-x-3">
          <button type="submit" id="login-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200">
            Login
          </button>
          <button type="button" id="register-btn" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-3 rounded-lg transition duration-200">
            Register
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, updateDoc, arrayUnion, arrayRemove, getDocs, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    
    // --- Global Variables (Canvas Provided) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // --- Firebase Initialization ---
    let app;
    let db;
    let auth;
    let unsubscribeUser = () => {};
    let unsubscribeAllUsers = () => {};
    
    // --- Global State ---
    let currentUser = null;
    let allUsers = [];
    let carriers = [];
    let stateNames = {};
    let currentLicenseUserId = null; // New state to track the user ID for license operations
    
    // --- Utility Functions ---
    function escapeHtml(unsafe) {
        if (unsafe === null || typeof unsafe === 'undefined') return '';
        return unsafe.toString()
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    function getStateName(abbr) {
        return stateNames[abbr] || abbr;
    }

    // --- Confirmation Modal Logic ---
    let confirmResolve;

    function openConfirmModal(message) {
        document.getElementById('confirm-message').textContent = message;
        document.getElementById('confirm-modal').classList.add('show');
        return new Promise(resolve => {
            confirmResolve = resolve;
        });
    }

    function closeConfirmModal() {
        document.getElementById('confirm-modal').classList.remove('show');
        confirmResolve = null;
    }

    document.getElementById('confirm-ok').addEventListener('click', () => {
        closeConfirmModal();
        if (confirmResolve) confirmResolve(true);
    });

    document.getElementById('confirm-cancel').addEventListener('click', () => {
        closeConfirmModal();
        if (confirmResolve) confirmResolve(false);
    });

    // --- UI/Modal Functions ---
    function showNotification(message, type = 'success') {
        const modal = document.getElementById('notification-modal');
        const content = document.getElementById('notification-content');
        
        content.textContent = message;
        content.className = `bg-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'yellow'}-600 p-4 rounded-lg shadow-2xl text-white text-center text-lg absolute top-4 fade-in`;
        modal.classList.add('show');
        modal.classList.remove('hidden');

        setTimeout(() => {
            modal.classList.remove('show');
            modal.classList.add('hidden');
        }, 3000);
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    function openLicenseModal(license = null, index = -1, targetUserId = null) {
        const modal = document.getElementById('license-modal');
        const title = document.getElementById('license-modal-title');
        const stateSelect = document.getElementById('license-state');
        const expirationInput = document.getElementById('license-expiration');
        const carriersContainer = document.getElementById('license-carriers');
        const indexInput = document.getElementById('license-index');
        const userIdInput = document.getElementById('license-user-id');
        
        // --- 1. SET THE TARGET USER ID (THE FIX) ---
        // If an ID is explicitly passed (from admin panel), use it. Otherwise, use the current user's ID.
        currentLicenseUserId = targetUserId || (currentUser ? currentUser.id : null);
        userIdInput.value = currentLicenseUserId; 
        
        title.textContent = index >= 0 ? 'Edit License' : 'Add License';
        indexInput.value = index;

        // Clear previous state
        stateSelect.value = license ? license.state : '';
        expirationInput.value = license ? license.expiration : '';
        carriersContainer.innerHTML = '';
        
        // Render carrier bubbles
        if (carriers.length > 0) {
            carriers.forEach(carrier => {
                const isSelected = license && license.carriers.includes(carrier);
                const bubble = document.createElement('span');
                bubble.className = `bubble text-sm ${isSelected ? 'selected' : ''}`;
                bubble.textContent = carrier;
                bubble.onclick = () => bubble.classList.toggle('selected');
                carriersContainer.appendChild(bubble);
            });
        } else {
            carriersContainer.innerHTML = '<p class="text-gray-400 text-sm">No carriers available. Add them in the Admin Panel.</p>';
        }

        modal.classList.add('show');
    }

    // --- Firebase Auth ---

    async function initFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in using the custom token or anonymously if not provided
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        // Set up Auth State Listener
        onAuthStateChanged(auth, (user) => {
          if (user) {
            setupUserListener(user.uid);
            document.getElementById('auth-modal').classList.remove('show');
          } else {
            currentUser = null;
            document.getElementById('auth-modal').classList.add('show');
            // Show loading placeholder while waiting for user data
            document.getElementById('loading-licenses').textContent = 'Please log in or register.';
          }
        });
      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        showNotification('Failed to initialize app: ' + error.message, 'error');
      }
    }

    // --- User Data Listeners ---

    function setupUserListener(uid) {
        // Unsubscribe from previous listener
        unsubscribeUser();
        
        const userDocRef = doc(db, `/artifacts/${appId}/users/${uid}/user_data/profile`);

        unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                currentUser = { id: uid, ...docSnap.data() };
                updateUI();
            } else {
                // User document doesn't exist, prompt for registration data if not already
                if (currentUser && currentUser.id === uid) {
                    showNotification("Profile data missing. Please fill out the registration form.", 'warning');
                }
            }
        }, (error) => {
            console.error("Error listening to user data:", error);
            showNotification('Error loading user data: ' + error.message, 'error');
        });
    }
    
    async function loadAllUsers() {
        if (!currentUser || !currentUser.is_admin) return;

        unsubscribeAllUsers(); // Stop previous listener

        const q = query(collection(db, `/artifacts/${appId}/users/`), where('id', '!=', '')); // Filter ensures only valid user subcollections are considered
        
        // This is not a real-time listener on the main users collection path due to Firestore limitations
        // Instead, we manually query all user profile documents.
        const usersRef = collection(db, `/artifacts/${appId}/users/`);
        const querySnapshot = await getDocs(usersRef);
        
        let fetchedUsers = [];
        
        for (const userSubCollection of querySnapshot.docs) {
            const userId = userSubCollection.id;
            const profileDocRef = doc(db, `/artifacts/${appId}/users/${userId}/user_data/profile`);
            const profileSnap = await getDoc(profileDocRef);

            if (profileSnap.exists()) {
                let userData = { id: userId, ...profileSnap.data() };
                
                // Add licenses from the current user document itself (for simplicity)
                if (userData.licenses) {
                    // Ensures the current user's data is always the most up-to-date in the admin view
                    if (userId === currentUser.id) {
                        userData = currentUser; 
                    }
                    fetchedUsers.push(userData);
                }
            }
        }
        
        // Simple client-side sorting: put current admin user first
        fetchedUsers.sort((a, b) => (a.id === currentUser.id ? -1 : (b.id === currentUser.id ? 1 : a.name.localeCompare(b.name))));
        allUsers = fetchedUsers;
    }

    async function loadCarriers() {
        const carriersDocRef = doc(db, `/artifacts/${appId}/public/data/app_settings/settings`);
        const docSnap = await getDoc(carriersDocRef);
        
        if (docSnap.exists() && docSnap.data().carriers) {
            carriers = docSnap.data().carriers;
        } else {
             // Initialize with defaults if missing
             carriers = ['State Farm', 'Allstate', 'Geico', 'Progressive', 'Liberty Mutual'];
             await setDoc(carriersDocRef, { carriers: carriers }, { merge: true });
        }
    }
    
    async function loadStateNames() {
        // Simple hardcoded list of state names for display purposes
        stateNames = {
            "AL": "Alabama", "AK": "Alaska", "AZ": "Arizona", "AR": "Arkansas", "CA": "California", "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware", "FL": "Florida", "GA": "Georgia", "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "IA": "Iowa", "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MD": "Maryland", "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri", "MT": "Montana", "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey", "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota", "OH": "Ohio", "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania", "RI": "Rhode Island", "SC": "South Carolina", "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont", "VA": "Virginia", "WA": "Washington", "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming"
        };
        const stateSelect = document.getElementById('license-state');
        Object.keys(stateNames).forEach(abbr => {
            const option = document.createElement('option');
            option.value = abbr;
            option.textContent = `${abbr} - ${stateNames[abbr]}`;
            stateSelect.appendChild(option);
        });
    }

    // --- UI Update Function ---

    function updateUI() {
        if (!currentUser) return;
        
        // Update User Dashboard
        document.getElementById('user-name').textContent = escapeHtml(currentUser.name);
        document.getElementById('user-npn').textContent = escapeHtml(currentUser.npn);
        document.getElementById('user-extension').textContent = escapeHtml(currentUser.extension);
        
        const licenses = currentUser.licenses || [];
        document.getElementById('total-licenses').textContent = licenses.length;
        displayLicenses(licenses, null, 'my-licenses-container');

        // Admin Panel Visibility
        const adminBtn = document.getElementById('admin-panel-btn');
        if (currentUser.is_admin) {
            adminBtn.classList.remove('hidden');
            loadCarriers(); // Load carriers for the admin panel and license modal
            
            // If currently in Admin view, refresh
            if (document.getElementById('admin-panel').style.display !== 'none') {
                loadAdminPanel();
            }
        } else {
            adminBtn.classList.add('hidden');
            // Ensure non-admins are on the dashboard
            document.getElementById('user-dashboard').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
        }
    }

    // --- License Management Functions ---

    function displayLicenses(licenses, query, containerId) {
        const container = document.getElementById(containerId);
        let html = '';

        if (licenses && licenses.length > 0) {
            licenses.forEach((license, index) => {
                const stateName = getStateName(license.state);
                // HTML for the license item
                html += `
                    <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center transition duration-200 hover:bg-gray-700">
                        <div>
                            <h4 class="font-bold text-lg text-cyan-300">${highlightMatch(escapeHtml(stateName), query)} (${highlightMatch(escapeHtml(license.state), query)})</h4>
                            <p class="text-gray-400 text-sm">Carriers: ${license.carriers.map(carrier => highlightMatch(escapeHtml(carrier), query)).join(', ')}</p>
                            ${license.expiration ? `<p class="text-gray-400 text-sm">Expires: ${escapeHtml(license.expiration)}</p>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="openLicenseModal({state: '${license.state}', expiration: '${license.expiration || ''}', carriers: [${license.carriers.map(c => `'${c}'`).join(', ')}]}, ${index})" class="bg-gray-600 hover:bg-gray-500 text-white p-2 rounded-full text-sm w-8 h-8 flex items-center justify-center" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteLicense(${index})" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full text-sm w-8 h-8 flex items-center justify-center" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        } else {
            html = '<p class="text-gray-400 text-center p-8">No licenses found. Click "Add License" to begin.</p>';
        }

        container.innerHTML = html;
    }

    async function saveLicense(event) {
        event.preventDefault();
        
        const state = document.getElementById('license-state').value;
        const expiration = document.getElementById('license-expiration').value;
        const index = parseInt(document.getElementById('license-index').value);
        const userId = document.getElementById('license-user-id').value; // Get the user ID from the hidden field
        
        const selectedCarriers = Array.from(document.getElementById('license-carriers').children)
            .filter(bubble => bubble.classList.contains('selected'))
            .map(bubble => bubble.textContent.trim());

        if (!state || selectedCarriers.length === 0) {
            showNotification('Please select a state and at least one carrier.', 'error');
            return;
        }

        closeModal('license-modal');
        
        // Determine if we are updating the current user or another agent
        const isSelfEdit = userId === currentUser.id;
        const targetUserId = userId || currentUser.id; // Fallback to current user ID
        const userDocRef = doc(db, `/artifacts/${appId}/users/${targetUserId}/user_data/profile`);
        
        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(userDocRef);
                if (!docSnap.exists()) {
                    throw new Error("User document does not exist.");
                }
                
                const userData = docSnap.data();
                const licenses = userData.licenses || [];
                
                const newLicense = {
                    state: state,
                    expiration: expiration || null,
                    carriers: selectedCarriers
                };
                
                let updatedLicenses;
                let message;

                if (index >= 0) {
                    // Edit existing license
                    updatedLicenses = licenses.map((l, i) => i === index ? newLicense : l);
                    message = `License for ${getStateName(state)} updated.`;
                } else {
                    // Add new license
                    // Check for duplicates
                    if (licenses.some(l => l.state === state)) {
                        throw new Error(`License for ${getStateName(state)} already exists. Use the edit button.`);
                    }
                    updatedLicenses = [...licenses, newLicense];
                    message = `License for ${getStateName(state)} added successfully.`;
                }
                
                transaction.update(userDocRef, { licenses: updatedLicenses });

                if (isSelfEdit) {
                    // Update local state immediately if the current user's licenses were changed
                    currentUser.licenses = updatedLicenses;
                    updateUI();
                } else {
                    // For admin editing another user, reload the admin panel to show changes
                    await loadAllUsers();
                    loadAdminPanel();
                }
                
                showNotification(message, 'success');

            });
        } catch(e) {
            console.error("License transaction failed:", e);
            showNotification('Error saving license: ' + e.message, 'error');
        }
    }
    
    // License form submission handler
    document.getElementById('license-form').addEventListener('submit', saveLicense);

    async function deleteLicense(index) {
        if (await openConfirmModal('Are you sure you want to delete this license?')) {
            await deleteLicenseInternal(index, currentUser.id);
        }
    }

    async function deleteUserLicense(userId, index) {
        if (await openConfirmModal(`Are you sure you want to delete this license for ${allUsers.find(u => u.id === userId)?.name || 'this agent'}?`)) {
            await deleteLicenseInternal(index, userId);
        }
    }

    async function deleteLicenseInternal(index, targetUserId) {
        const userDocRef = doc(db, `/artifacts/${appId}/users/${targetUserId}/user_data/profile`);
        const isSelfEdit = targetUserId === currentUser.id;

        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(userDocRef);
                if (!docSnap.exists()) {
                    throw new Error("User document does not exist.");
                }
                
                const userData = docSnap.data();
                const licenses = userData.licenses || [];
                
                if (index < 0 || index >= licenses.length) {
                    throw new Error("Invalid license index.");
                }
                
                const updatedLicenses = licenses.filter((_, i) => i !== index);
                
                transaction.update(userDocRef, { licenses: updatedLicenses });

                if (isSelfEdit) {
                    currentUser.licenses = updatedLicenses;
                    updateUI();
                } else {
                    // For admin editing another user, reload the admin panel to show changes
                    await loadAllUsers();
                    loadAdminPanel();
                }
                
                showNotification('License deleted successfully.', 'success');
            });

        } catch(e) {
            console.error("License deletion failed:", e);
            showNotification('Error deleting license: ' + e.message, 'error');
        }
    }

    // ------------------- Search and Highlight -------------------
    function highlightMatch(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    function escapeRegex(string) {
        // Correctly escapes regex special characters by prefixing them with a backslash
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // --- Admin Panel Functions ---

    // Function to render the admin panel content
    async function loadAdminPanel() {
        if (!currentUser || !currentUser.is_admin) return;

        // 1. Load Carriers List
        const carriersList = document.getElementById('carriers-list');
        carriersList.innerHTML = '';

        if (carriers.length > 0) {
            carriers.forEach(carrier => {
                carriersList.innerHTML += `
                    <div class="bubble bg-gray-600 hover:bg-gray-500" onclick="confirmAndRemoveCarrier('${carrier}')">
                        ${escapeHtml(carrier)} <i class="fas fa-times ml-1 text-red-400"></i>
                    </div>
                `;
            });
        } else {
            carriersList.innerHTML = '<p class="text-gray-400 text-sm">No carriers defined.</p>';
        }


        // 2. Render Users List
        const container = document.getElementById('all-users-container');
        let usersHtml = '';
        const query = document.getElementById('user-search').value.toLowerCase();
        
        const filteredUsers = allUsers.filter(user => 
            !query || 
            user.name.toLowerCase().includes(query) || 
            user.email.toLowerCase().includes(query) || 
            user.npn.toLowerCase().includes(query)
        );

        if (filteredUsers.length === 0) {
            usersHtml = '<p class="text-gray-400 text-center p-8">No agents found matching your search.</p>';
        } else {
            filteredUsers.forEach(user => {
                const licenseCount = (user.licenses || []).length;
                const uniqueStates = new Set((user.licenses || []).map(l => l.state));
                const stateCount = uniqueStates.size;
                const isCurrentUser = user.id === currentUser.id;
                
                let licensesHtml = '';
                if (user.licenses && user.licenses.length > 0) {
                    user.licenses.forEach((license, index) => {
                        const stateName = getStateName(license.state);
                        // The crucial change: Passing the target user's ID to the edit/delete functions
                        licensesHtml += `
                            <div class="bg-gray-700 p-3 rounded mb-2 flex justify-between items-center">
                                <div>
                                    <h4 class="font-semibold">${highlightMatch(escapeHtml(stateName), query)} (${highlightMatch(escapeHtml(license.state), query)})</h4>
                                    <p class="text-gray-300 text-sm">Carriers: ${license.carriers.map(carrier => highlightMatch(escapeHtml(carrier), query)).join(', ')}</p>
                                    ${license.expiration ? `<p class="text-gray-400 text-sm">Expires: ${escapeHtml(license.expiration)}</p>` : ''}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="openLicenseModal({state: '${license.state}', expiration: '${license.expiration || ''}', carriers: [${license.carriers.map(c => `'${c}'`).join(', ')}]}, ${index}, '${user.id}')" class="bg-gray-600 hover:bg-gray-500 text-white p-2 rounded-full text-sm w-7 h-7 flex items-center justify-center" title="Edit License">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteUserLicense('${user.id}', ${index})" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full text-sm w-7 h-7 flex items-center justify-center" title="Delete License">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    licensesHtml = '<p class="text-gray-400 text-sm p-2">No licenses</p>';
                }
                
                usersHtml += `
                    <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-cyan-300 text-lg">${highlightMatch(escapeHtml(user.name), query)} ${isCurrentUser ? '(You)' : ''}</h4>
                                <p class="text-gray-400 text-sm">${highlightMatch(escapeHtml(user.email), query)}</p>
                                <p class="text-gray-400 text-sm">NPN: ${highlightMatch(escapeHtml(user.npn), query)} | Ext: ${highlightMatch(escapeHtml(user.extension), query)}</p>
                                <p class="text-xs text-gray-500 mt-1">User ID: ${user.id}</p>
                            </div>
                            <div class="flex flex-col items-end space-y-2">
                                <span class="${user.is_admin ? 'bg-red-600' : 'bg-green-600'} px-3 py-1 rounded text-xs font-bold">${user.is_admin ? 'Admin' : 'Agent'}</span>
                                <button onclick="toggleAdminStatus('${user.id}', ${user.is_admin})" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-1 px-3 rounded text-xs transition duration-200" ${isCurrentUser ? 'disabled' : ''}>
                                    ${user.is_admin ? 'Revoke Admin' : 'Make Admin'}
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-4 text-center border-t border-b border-gray-700 py-3">
                            <div class="bg-gray-700 p-2 rounded-lg">
                                <div class="text-xl font-bold text-cyan-400">${licenseCount}</div>
                                <div class="text-xs text-gray-400">Licenses</div>
                            </div>
                            <div class="bg-gray-700 p-2 rounded-lg">
                                <div class="text-xl font-bold text-cyan-400">${stateCount}</div>
                                <div class="text-xs text-gray-400">States</div>
                            </div>
                            <button onclick="openLicenseModal(null, -1, '${user.id}')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                                <i class="fas fa-plus mr-1"></i>Add License
                            </button>
                        </div>
                        <h5 class="font-semibold text-gray-300 mb-2">License Details:</h5>
                        <div class="space-y-2">
                            ${licensesHtml}
                        </div>
                    </div>
                `;
            });
        }
        
        container.innerHTML = usersHtml;
    }

    // ------------------- Admin Actions -------------------
    
    async function toggleAdminStatus(userId, currentStatus) {
        const action = currentStatus ? 'revoke Admin status from' : 'grant Admin status to';
        if (!await openConfirmModal(`Are you sure you want to ${action} this user?`)) return;

        const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/user_data/profile`);
        try {
            await updateDoc(userDocRef, { is_admin: !currentStatus });
            showNotification(`Admin status ${currentStatus ? 'revoked' : 'granted'} successfully.`, 'success');
            await loadAllUsers();
            loadAdminPanel();
        } catch(e) {
            console.error('Error toggling admin status:', e);
            showNotification('Error toggling admin status: ' + e.message, 'error');
        }
    }

    async function addCarrier() {
        const input = document.getElementById('new-carrier-name');
        const carrierName = input.value.trim();
        
        if (!carrierName) {
            showNotification('Please enter a carrier name', 'error');
            return;
        }
        
        if (carriers.includes(carrierName)) {
            showNotification('Carrier already exists', 'warning');
            return;
        }
        
        const carriersDocRef = doc(db, `/artifacts/${appId}/public/data/app_settings/settings`);
        
        try {
            await updateDoc(carriersDocRef, {
                carriers: arrayUnion(carrierName)
            });
            
            carriers.push(carrierName);
            input.value = '';
            
            showNotification(`Added carrier: ${carrierName}`, 'success');
            loadAdminPanel();
        } catch(error) {
            console.error(error);
            showNotification('Error adding carrier: ' + error.message, 'error');
        }
    }

    async function confirmAndRemoveCarrier(carrierName) {
        if (!await openConfirmModal(`Are you sure you want to remove the carrier "${carrierName}"? This affects all users.`)) return;
        
        const carriersDocRef = doc(db, `/artifacts/${appId}/public/data/app_settings/settings`);

        try {
            await updateDoc(carriersDocRef, {
                carriers: arrayRemove(carrierName)
            });

            carriers = carriers.filter(c => c !== carrierName);
            showNotification(`Removed carrier: ${carrierName}`, 'success');
            loadAdminPanel();
        } catch(error) {
            console.error(error);
            showNotification('Error removing carrier: ' + error.message, 'error');
        }
    }
    
    // ------------------- Authentication and Registration -------------------
    
    async function handleAuth(event) {
        event.preventDefault();

        const npn = document.getElementById('auth-npn').value.trim();
        const extension = document.getElementById('auth-extension').value.trim();
        const name = document.getElementById('auth-name').value.trim();
        const email = document.getElementById('auth-email').value.trim();

        const isRegistration = event.submitter.id === 'register-btn';

        if (!npn || !extension) {
            showNotification('NPN and Extension are required.', 'error');
            return;
        }
        
        if (isRegistration && (!name || !email)) {
             showNotification('Name and Email are required for registration.', 'error');
            return;
        }

        const q = query(collection(db, `/artifacts/${appId}/users/`), where('npn', '==', npn), where('extension', '==', extension));
        const qSnap = await getDocs(q);

        if (isRegistration) {
            if (!qSnap.empty) {
                showNotification('An account with this NPN and Extension already exists.', 'error');
                return;
            }
        } else { // Login
            if (qSnap.empty) {
                showNotification('No account found with this NPN and Extension.', 'error');
                return;
            }
        }

        try {
            const user = auth.currentUser;
            if (!user) {
                throw new Error("User not authenticated.");
            }
            
            const userDocRef = doc(db, `/artifacts/${appId}/users/${user.uid}/user_data/profile`);
            
            if (isRegistration) {
                // Register: create the profile document
                await setDoc(userDocRef, {
                    npn: npn,
                    extension: extension,
                    name: name,
                    email: email,
                    is_admin: false,
                    licenses: []
                });
                showNotification('Registration successful! Logging in...', 'success');
            } else {
                // Login: simply rely on the existing user listener to fetch the profile
                showNotification('Login successful!', 'success');
            }
            
            // Clear form and close modal
            document.getElementById('auth-form').reset();
            document.getElementById('auth-modal').classList.remove('show');

        } catch(error) {
            console.error('Auth error:', error);
            showNotification('Authentication failed: ' + error.message, 'error');
        }
    }
    
    async function handleLogout() {
        if (!await openConfirmModal('Are you sure you want to log out?')) return;
        try {
            await signOut(auth);
            // Re-sign in anonymously after sign-out to ensure the environment is ready for re-login
            await signInAnonymously(auth); 
            showNotification('Logged out successfully.', 'success');
            
            // Clear local state
            currentUser = null;
            allUsers = [];
            
            // Hide admin panel and show dashboard/login
            document.getElementById('user-dashboard').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            
            // Reload UI
            updateUI(); 
        } catch (error) {
            console.error('Logout error:', error);
            showNotification('Logout failed: ' + error.message, 'error');
        }
    }
    
    // --- Event Listeners ---
    
    document.getElementById('auth-form').addEventListener('submit', handleAuth);
    document.getElementById('register-btn').addEventListener('click', (e) => handleAuth({...e, submitter: document.getElementById('register-btn')}));
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    
    // Admin Panel Toggling
    document.getElementById('admin-panel-btn').addEventListener('click', async () => {
        const dashboard = document.getElementById('user-dashboard');
        const adminPanel = document.getElementById('admin-panel');

        if (dashboard.classList.contains('hidden')) {
            // Switch to Dashboard
            dashboard.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            document.getElementById('admin-panel-btn').innerHTML = '<i class="fas fa-user-shield mr-2"></i>Admin Panel';
        } else {
            // Switch to Admin Panel
            await loadAllUsers();
            loadAdminPanel();
            dashboard.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            document.getElementById('admin-panel-btn').innerHTML = '<i class="fas fa-tachometer-alt mr-2"></i>My Dashboard';
        }
    });

    // Admin Search
    document.getElementById('user-search').addEventListener('input', loadAdminPanel);

    // Make utility functions global for inline onclick handlers
    window.openLicenseModal = openLicenseModal;
    window.deleteLicense = deleteLicense;
    window.deleteUserLicense = deleteUserLicense;
    window.toggleAdminStatus = toggleAdminStatus;
    window.addCarrier = addCarrier; // Add to global scope if needed for future admin features
    window.confirmAndRemoveCarrier = confirmAndRemoveCarrier;
    window.closeModal = closeModal;
    window.showNotification = showNotification;
    
    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initFirebase();
        await loadStateNames();
        // Carriers are loaded either by updateUI (for non-admins) or loadAdminPanel (for admins)
    });

  </script>
</body>
</html>
