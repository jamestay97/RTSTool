<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insurance License Data Explorer (Supabase)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #22d3ee; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .fade-in { animation: fadeIn 0.4s ease-in; }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.75); z-index:1000; align-items: center; justify-content:center; }
    .modal-content { background: #374151; border-radius: 12px; max-width: 720px; width: 95%; max-height: 90vh; overflow-y: auto; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<nav class="bg-gray-800 p-4">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-2xl font-bold text-cyan-400"><i class="fas fa-id-card-alt mr-2"></i>License Explorer</h1>
    <div id="nav-buttons" class="hidden">
      <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition">
        <i class="fas fa-sign-out-alt mr-2"></i>Logout
      </button>
    </div>
  </div>
</nav>

<div class="container mx-auto p-4">
  <div id="loading-screen" class="flex flex-col items-center justify-center min-h-[60vh] fade-in">
    <div class="loading-spinner mb-4"></div>
    <p class="text-xl">Loading Application...</p>
  </div>

  <!-- AUTH SCREEN -->
  <div id="auth-screen" class="hidden max-w-4xl mx-auto fade-in">
    <div class="bg-gray-800 rounded-xl p-8 shadow-2xl">
      <h2 class="text-3xl font-bold text-center mb-8 text-cyan-400"><i class="fas fa-shield-alt mr-3"></i>Agent Portal</h2>
      <div class="grid md:grid-cols-2 gap-8">
        <!-- LOGIN -->
        <div class="bg-gray-700 p-6 rounded-lg">
          <h3 class="text-2xl font-semibold mb-4 text-green-400"><i class="fas fa-sign-in-alt mr-2"></i>Login</h3>
          <form id="login-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Email</label>
              <input id="login-email" type="email" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="admin@licenseexplorer.com" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Password</label>
              <input id="login-password" type="password" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="Enter password" required>
            </div>
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-semibold">
              <i class="fas fa-unlock mr-2"></i>Login to Dashboard
            </button>
          </form>

          <div class="mt-4 p-3 bg-gray-800 rounded-lg text-sm">
            <p class="text-cyan-300 font-semibold">Demo Account:</p>
            <p class="text-gray-400">Admin: admin@licenseexplorer.com / admin123</p>
          </div>
        </div>

        <!-- REGISTER -->
        <div class="bg-gray-700 p-6 rounded-lg">
          <h3 class="text-2xl font-semibold mb-4 text-blue-400"><i class="fas fa-user-plus mr-2"></i>Register</h3>
          <form id="register-form" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">First Name</label>
                <input id="register-firstname" type="text" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="John" required>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Last Name</label>
                <input id="register-lastname" type="text" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="Smith" required>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-2">Email</label>
              <input id="register-email" type="email" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="john@company.com" required>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">NPN Number</label>
                <input id="register-npn" type="text" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="123456789" required>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Extension</label>
                <input id="register-extension" type="text" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="1234" maxlength="4" required>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-2">Password</label>
              <input id="register-password" type="password" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="Create password (min. 6 characters)" required>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold">
              <i class="fas fa-user-check mr-2"></i>Create Account
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden max-w-6xl mx-auto fade-in">
    <div class="bg-gradient-to-r from-cyan-900 to-blue-900 rounded-xl p-6 mb-8 shadow-2xl">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold mb-2">Welcome back, <span id="user-name" class="text-cyan-300"></span>!</h2>
          <p class="text-gray-300">License Data Explorer Dashboard</p>
        </div>
        <div class="mt-4 md:mt-0 flex items-center space-x-2">
          <span id="user-badge" class="bg-green-600 px-3 py-1 rounded-full text-sm font-semibold">Licensed Agent</span>
          <span id="admin-badge" class="bg-red-600 px-3 py-1 rounded-full text-sm font-semibold hidden"><i class="fas fa-crown mr-1"></i>Administrator</span>
        </div>
      </div>
    </div>

    <div class="bg-gray-800 rounded-xl p-6 shadow-2xl">
      <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-700 pb-4">
        <button class="tab-btn active bg-cyan-600 px-4 py-2 rounded-lg font-semibold transition" data-tab="search"><i class="fas fa-search mr-2"></i>Search Licenses</button>
        <button class="tab-btn bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold transition" data-tab="profile"><i class="fas fa-user mr-2"></i>My Profile</button>
        <button class="tab-btn bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold transition" data-tab="licenses"><i class="fas fa-id-card mr-2"></i>My Licenses</button>
        <button id="admin-tab-btn" class="tab-btn bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold transition hidden" data-tab="admin"><i class="fas fa-users-cog mr-2"></i>Admin Panel</button>
      </div>

      <div id="tab-content">
        <!-- SEARCH -->
        <div id="search-tab" class="tab-panel active">
          <div class="mb-6">
            <div class="flex flex-col sm:flex-row gap-4">
              <input id="search-input" class="flex-1 p-4 bg-gray-700 rounded-lg border border-gray-600" placeholder="Search by exact state (California or CA), agent name, email, NPN, or carrier...">
              <button id="search-btn" class="bg-cyan-600 hover:bg-cyan-700 px-6 py-4 rounded-lg font-semibold transition whitespace-nowrap"><i class="fas fa-search mr-2"></i>Search</button>
            </div>
          </div>
          <div id="search-results" class="bg-gray-700 rounded-lg p-6 min-h-[300px]">
            <div class="text-center text-gray-400">
              <i class="fas fa-compass text-4xl mb-4"></i>
              <p class="text-xl">Enter a search term to find license data</p>
            </div>
          </div>
        </div>

        <!-- PROFILE -->
        <div id="profile-tab" class="tab-panel hidden">
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-gray-700 p-6 rounded-lg">
              <h3 class="text-xl font-semibold mb-4 text-cyan-400">Agent Information</h3>
              <div class="space-y-3">
                <p><strong class="text-gray-300">Name:</strong> <span id="profile-name" class="text-white"></span></p>
                <p><strong class="text-gray-300">Email:</strong> <span id="profile-email" class="text-white"></span></p>
                <p><strong class="text-gray-300">NPN:</strong> <span id="profile-npn" class="text-white"></span></p>
                <p><strong class="text-gray-300">Extension:</strong> <span id="profile-extension" class="text-white"></span></p>
                <p><strong class="text-gray-300">Status:</strong> <span class="text-green-400 font-semibold">Active</span></p>
              </div>
            </div>
            <div class="bg-gray-700 p-6 rounded-lg">
              <h3 class="text-xl font-semibold mb-4 text-cyan-400">Quick Stats</h3>
              <div class="space-y-3">
                <p><strong class="text-gray-300">Licensed States:</strong> <span id="states-count" class="text-white">0</span></p>
                <p><strong class="text-gray-300">Carriers:</strong> <span id="carriers-count" class="text-white">0</span></p>
                <p><strong class="text-gray-300">Member Since:</strong> <span class="text-white" id="member-since">2024</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- MY LICENSES -->
        <div id="licenses-tab" class="tab-panel hidden">
          <div class="mb-6">
            <h3 class="text-2xl font-semibold mb-4 text-cyan-400">My License Portfolio</h3>
            <div id="licenses-container" class="space-y-4"></div>
            <button id="add-license-btn" class="mt-4 bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Add License</button>
          </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="admin-tab" class="tab-panel hidden">
          <div class="mb-6">
            <h3 class="text-2xl font-semibold mb-4 text-red-400"><i class="fas fa-users-cog mr-2"></i>User Management</h3>
            <div class="bg-gray-700 rounded-lg p-4 mb-4">
              <p class="text-gray-300">Total Users: <span id="total-users" class="text-white font-semibold">0</span></p>
              <p class="text-gray-300">Admins: <span id="admin-count" class="text-white font-semibold">0</span></p>
              <p class="text-gray-300">Agents: <span id="agent-count" class="text-white font-semibold">0</span></p>
            </div>
            <div id="users-list" class="space-y-4"></div>
          </div>

          <div class="mb-6">
            <h3 class="text-2xl font-semibold mb-4 text-purple-400"><i class="fas fa-list-alt mr-2"></i>Carrier Management</h3>
            <div class="bg-gray-700 rounded-lg p-4 mb-4">
              <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input id="new-carrier-input" type="text" class="flex-1 p-3 bg-gray-600 rounded-lg border border-gray-500" placeholder="Enter new carrier name">
                <button id="add-carrier-btn" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i>Add Carrier</button>
              </div>
              <div id="carriers-list" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADD LICENSE MODAL -->
<div id="add-license-modal" class="modal">
  <div class="modal-content p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-cyan-400" id="add-license-title">Add New License</h3>
      <button id="close-add-license-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
    </div>
    <form id="add-license-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">Select States (you may choose multiple)</label>
        <div id="add-license-states" class="bg-gray-700 p-3 rounded-lg max-h-40 overflow-y-auto grid grid-cols-2 gap-2"></div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Carriers (choose one or more)</label>
        <div id="carriers-container" class="space-y-2 max-h-40 overflow-y-auto p-2 bg-gray-700 rounded-lg"></div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Expiration Date</label>
        <input id="license-expiration" type="date" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500 text-white">
      </div>
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" id="cancel-add-license" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg">Cancel</button>
        <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded-lg">Add License</button>
      </div>
    </form>
  </div>
</div>

<script>
// âœ… CORRECT SUPABASE CREDENTIALS
const SUPABASE_URL = 'https://sdkprilrlnfuqkotwfyd.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNka3ByaWxybG5mdXFrb3R3ZnlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDA5MTksImV4cCI6MjA3NTQ3NjkxOX0.2E1jqwtXv03Jtc3nN1sRS3ZTIm4N02ftoX1G5NWef10';

// Initialize Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// States data
const STATES_DATA = [
  { name: "Alabama", abbreviation: "AL" }, { name: "Alaska", abbreviation: "AK" }, { name: "Arizona", abbreviation: "AZ" },
  { name: "Arkansas", abbreviation: "AR" }, { name: "California", abbreviation: "CA" }, { name: "Colorado", abbreviation: "CO" },
  { name: "Connecticut", abbreviation: "CT" }, { name: "Delaware", abbreviation: "DE" }, { name: "Florida", abbreviation: "FL" },
  { name: "Georgia", abbreviation: "GA" }, { name: "Hawaii", abbreviation: "HI" }, { name: "Idaho", abbreviation: "ID" },
  { name: "Illinois", abbreviation: "IL" }, { name: "Indiana", abbreviation: "IN" }, { name: "Iowa", abbreviation: "IA" },
  { name: "Kansas", abbreviation: "KS" }, { name: "Kentucky", abbreviation: "KY" }, { name: "Louisiana", abbreviation: "LA" },
  { name: "Maine", abbreviation: "ME" }, { name: "Maryland", abbreviation: "MD" }, { name: "Massachusetts", abbreviation: "MA" },
  { name: "Michigan", abbreviation: "MI" }, { name: "Minnesota", abbreviation: "MN" }, { name: "Mississippi", abbreviation: "MS" },
  { name: "Missouri", abbreviation: "MO" }, { name: "Montana", abbreviation: "MT" }, { name: "Nebraska", abbreviation: "NE" },
  { name: "Nevada", abbreviation: "NV" }, { name: "New Hampshire", abbreviation: "NH" }, { name: "New Jersey", abbreviation: "NJ" },
  { name: "New Mexico", abbreviation: "NM" }, { name: "New York", abbreviation: "NY" }, { name: "North Carolina", abbreviation: "NC" },
  { name: "North Dakota", abbreviation: "ND" }, { name: "Ohio", abbreviation: "OH" }, { name: "Oklahoma", abbreviation: "OK" },
  { name: "Oregon", abbreviation: "OR" }, { name: "Pennsylvania", abbreviation: "PA" }, { name: "Rhode Island", abbreviation: "RI" },
  { name: "South Carolina", abbreviation: "SC" }, { name: "South Dakota", abbreviation: "SD" }, { name: "Tennessee", abbreviation: "TN" },
  { name: "Texas", abbreviation: "TX" }, { name: "Utah", abbreviation: "UT" }, { name: "Vermont", abbreviation: "VT" },
  { name: "Virginia", abbreviation: "VA" }, { name: "Washington", abbreviation: "WA" }, { name: "West Virginia", abbreviation: "WV" },
  { name: "Wisconsin", abbreviation: "WI" }, { name: "Wyoming", abbreviation: "WY" }
];

// Default carriers
const DEFAULT_CARRIERS = ["State Farm", "Allstate", "Geico", "Progressive", "Liberty Mutual", "Nationwide", "Farmers", "USAA", "American Family", "Travelers"];

// App state
let currentUser = null;
let allUsers = [];
let carriers = [];
let currentEditingUserId = null;

// Initialize app
document.addEventListener('DOMContentLoaded', async () => {
  await initApp();
});

async function initApp() {
  try {
    // Load carriers
    await loadCarriers();
    
    // Check for existing session
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session) {
      await loadUserData(session.user.id);
    } else {
      // Check if we can connect to Supabase
      const { data, error } = await supabase.from('users').select('count').limit(1);
      if (error) {
        showNotification('Database not set up. Please run the SQL schema in Supabase.', 'error');
      }
      showAuthScreen();
    }
    
    setupEventListeners();
    populateStateCheckboxes();
    populateCarriersCheckboxes();
    
  } catch (error) {
    console.error('Init error:', error);
    showNotification('Error initializing app', 'error');
    showAuthScreen();
  }
}

// Data management functions
async function loadCarriers() {
  const { data, error } = await supabase.from('app_settings').select('carriers').single();
  if (error) {
    console.error('Error loading carriers:', error);
    carriers = DEFAULT_CARRIERS;
  } else {
    carriers = data.carriers || DEFAULT_CARRIERS;
  }
}

async function loadUserData(userId) {
  const { data: user, error } = await supabase.from('users').select('*').eq('id', userId).single();
  if (error) {
    showNotification('Error loading user data', 'error');
    return;
  }
  if (user) {
    currentUser = user;
    await loadAllUsers();
    showDashboard();
  }
}

async function loadAllUsers() {
  const { data: users, error } = await supabase.from('users').select('*').order('name');
  if (!error) {
    allUsers = users;
  }
}

// Authentication
async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  
  const { data: user, error } = await supabase
    .from('users')
    .select('*')
    .eq('email', email)
    .eq('password', password)
    .single();
  
  if (user) {
    currentUser = user;
    await loadAllUsers();
    showDashboard();
    showNotification('Login successful!', 'success');
  } else {
    showNotification('Invalid email or password', 'error');
  }
}

async function handleRegister(e) {
  e.preventDefault();
  const firstname = document.getElementById('register-firstname').value;
  const lastname = document.getElementById('register-lastname').value;
  const email = document.getElementById('register-email').value;
  const npn = document.getElementById('register-npn').value;
  const extension = document.getElementById('register-extension').value;
  const password = document.getElementById('register-password').value;
  
  // Check if email exists
  const { data: existingUser } = await supabase.from('users').select('id').eq('email', email).single();
  if (existingUser) {
    showNotification('Email already registered', 'error');
    return;
  }
  
  const newUser = {
    email,
    password,
    firstname,
    lastname,
    name: `${firstname} ${lastname}`,
    npn,
    extension,
    is_admin: false,
    licenses: []
  };
  
  const { error } = await supabase.from('users').insert([newUser]);
  if (error) {
    showNotification('Registration failed: ' + error.message, 'error');
  } else {
    showNotification('Registration successful! You can now login.', 'success');
    document.getElementById('register-form').reset();
  }
}

async function handleLogout() {
  currentUser = null;
  showAuthScreen();
  showNotification('Logged out successfully', 'info');
}

// UI Management
function showAuthScreen() {
  document.getElementById('loading-screen').classList.add('hidden');
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('nav-buttons').classList.add('hidden');
}

function showDashboard() {
  document.getElementById('loading-screen').classList.add('hidden');
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('nav-buttons').classList.remove('hidden');
  
  // Update user info
  document.getElementById('user-name').textContent = currentUser.name;
  document.getElementById('profile-name').textContent = currentUser.name;
  document.getElementById('profile-email').textContent = currentUser.email;
  document.getElementById('profile-npn').textContent = currentUser.npn;
  document.getElementById('profile-extension').textContent = currentUser.extension;
  document.getElementById('member-since').textContent = currentUser.join_date;
  
  // Update admin status
  if (currentUser.is_admin) {
    document.getElementById('admin-tab-btn').classList.remove('hidden');
    document.getElementById('admin-badge').classList.remove('hidden');
    document.getElementById('user-badge').classList.add('hidden');
  } else {
    document.getElementById('admin-tab-btn').classList.add('hidden');
    document.getElementById('admin-badge').classList.add('hidden');
    document.getElementById('user-badge').classList.remove('hidden');
  }
  
  updateUserStats();
  loadUserLicenses();
  if (currentUser.is_admin) loadAdminPanel();
}

// Setup all other functions (license management, search, admin panel, etc.)
// ... [Include all the other functions from the previous implementation]

// For now, let's set up basic event listeners
function setupEventListeners() {
  document.getElementById('login-form').addEventListener('submit', handleLogin);
  document.getElementById('register-form').addEventListener('submit', handleRegister);
  document.getElementById('logout-btn').addEventListener('click', handleLogout);
  document.getElementById('search-btn').addEventListener('click', performSearch);
  document.getElementById('add-license-btn').addEventListener('click', openAddLicenseModal);
}

function populateStateCheckboxes() {
  const container = document.getElementById('add-license-states');
  container.innerHTML = '';
  STATES_DATA.forEach(state => {
    const label = document.createElement('label');
    label.className = 'flex items-center space-x-2 cursor-pointer';
    label.innerHTML = `<input type="checkbox" value="${state.abbreviation}" class="license-state-checkbox"> <span>${state.name} (${state.abbreviation})</span>`;
    container.appendChild(label);
  });
}

function populateCarriersCheckboxes() {
  const container = document.getElementById('carriers-container');
  container.innerHTML = '';
  carriers.forEach(carrier => {
    const label = document.createElement('label');
    label.className = 'flex items-center space-x-2 cursor-pointer';
    label.innerHTML = `<input type="checkbox" value="${carrier}" class="carrier-checkbox"> <span>${carrier}</span>`;
    container.appendChild(label);
  });
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-2xl z-50 fade-in ${
    type === 'success' ? 'bg-green-600' : 
    type === 'error' ? 'bg-red-600' : 'bg-blue-600'
  }`;
  notification.innerHTML = `<div class="flex items-center">
    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} mr-2"></i>
    <span>${message}</span>
  </div>`;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3500);
}

// Placeholder functions - you'll need to implement these
function performSearch() { showNotification('Search functionality coming soon', 'info'); }
function openAddLicenseModal() { showNotification('Add license modal coming soon', 'info'); }
function loadUserLicenses() { /* TODO */ }
function updateUserStats() { /* TODO */ }
function loadAdminPanel() { /* TODO */ }

</script>
</body>
</html>
