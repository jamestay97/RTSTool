<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Insurance License Data Explorer</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  .bubble{padding:4px 8px;border-radius:9999px;cursor:pointer;display:inline-block;background:#1f2937;color:white;margin:2px;}
  .bubble.selected{background:#06b6d4;}
  .search-highlight{background:yellow;color:black;}
  .fade-in{animation:fadeIn 0.3s ease-in;}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<div id="loading-screen" class="flex flex-col items-center justify-center min-h-[60vh]">
  <div class="border-4 border-t-cyan-400 rounded-full w-10 h-10 animate-spin mb-3"></div>
  <p class="text-lg">Loading...</p>
</div>

<div id="auth-screen" class="hidden text-center mt-10">
  <h2 class="text-3xl font-bold text-cyan-400 mb-4">Login</h2>
  <form id="login-form" class="space-y-3 max-w-sm mx-auto">
    <input id="login-email" type="email" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Email" required />
    <input id="login-password" type="password" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Password" required />
    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 py-2 rounded">Login</button>
  </form>
  <p class="mt-3 text-gray-400">Don't have an account? <span id="show-register" class="text-cyan-400 cursor-pointer">Register</span></p>
  <form id="register-form" class="space-y-3 max-w-sm mx-auto mt-4 hidden">
    <input id="register-firstname" placeholder="First Name" class="w-full p-2 rounded bg-gray-800 border border-gray-700" required />
    <input id="register-lastname" placeholder="Last Name" class="w-full p-2 rounded bg-gray-800 border border-gray-700" required />
    <input id="register-email" type="email" placeholder="Email" class="w-full p-2 rounded bg-gray-800 border border-gray-700" required />
    <input id="register-npn" placeholder="NPN" class="w-full p-2 rounded bg-gray-800 border border-gray-700" required />
    <input id="register-extension" placeholder="Extension" class="w-full p-2 rounded bg-gray-800 border border-gray-700" required />
    <input id="register-password" type="password" placeholder="Password" class="w-full p-2 rounded bg-gray-800 border border-gray-700" required />
    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded">Register</button>
  </form>
</div>

<div id="dashboard" class="hidden p-6">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Welcome, <span id="user-name" class="text-cyan-300"></span></h1>
    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Logout</button>
  </div>

  <div id="nav-buttons" class="flex space-x-2 mb-6">
    <button class="tab-btn bg-cyan-600 px-4 py-2 rounded" data-tab="search">Search</button>
    <button class="tab-btn bg-gray-700 px-4 py-2 rounded" data-tab="licenses">Licenses</button>
    <button id="admin-tab-btn" class="tab-btn bg-gray-700 px-4 py-2 rounded hidden" data-tab="admin">Admin</button>
  </div>

  <div id="search-tab" class="tab-panel">
    <div class="flex mb-4">
      <input id="search-input" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Search by state, carrier, name, email, NPN" />
      <button id="search-btn" class="ml-2 bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded">Search</button>
    </div>
    <div id="search-results"></div>
  </div>

  <div id="licenses-tab" class="tab-panel hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Your Licenses</h2>
      <button id="add-license-btn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Add License</button>
    </div>
    <div id="licenses-container"></div>
  </div>

  <div id="admin-tab" class="tab-panel hidden">
    <h2 class="text-xl font-bold mb-4">Admin Panel</h2>
    <div id="users-list"></div>
    <div class="mt-6">
      <h3 class="text-lg font-semibold mb-2">Manage Carriers</h3>
      <div class="flex mb-2">
        <input id="new-carrier-input" placeholder="New Carrier" class="w-full p-2 rounded bg-gray-800 border border-gray-700" />
        <button id="add-carrier-btn" class="ml-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Add</button>
      </div>
      <div id="carriers-list"></div>
    </div>
  </div>
</div>

<div id="add-license-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
  <div class="bg-gray-800 p-6 rounded w-full max-w-lg">
    <h3 class="text-lg font-bold mb-3">Add License</h3>
    <form id="add-license-form" class="space-y-3">
      <div>
        <label class="block mb-1">States</label>
        <div id="add-license-states" class="flex flex-wrap"></div>
      </div>
      <div>
        <label class="block mb-1">Carriers</label>
        <div id="carriers-container" class="flex flex-wrap"></div>
      </div>
      <div>
        <label class="block mb-1">Expiration</label>
        <input type="date" id="license-expiration" class="w-full p-2 rounded bg-gray-700 border border-gray-600" />
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" id="cancel-add-license" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Add</button>
      </div>
    </form>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://sdkprilrlnfuqkotwfyd.supabase.co';
const SUPABASE_KEY = 'YOUR_ANON_KEY_HERE';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const STATES_DATA = [ /* same as previous full list */ ];

let currentUser = null;
let allUsers = [];
let carriers = [];

// -----------------------
function show(id){document.getElementById(id).classList.remove('hidden');}
function hide(id){document.getElementById(id).classList.add('hidden');}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text||'';return div.innerHTML;}

// -----------------------
// Initialization
document.addEventListener('DOMContentLoaded', async ()=>{
  hide('auth-screen');show('loading-screen');
  const { data: { session } } = await supabase.auth.getSession();
  if(session){
    const email=session.user.email;
    const { data: users } = await supabase.from('users').select('*').eq('email',email);
    currentUser=users[0];
    await loadAllUsers();
    showDashboard();
  } else {
    hide('loading-screen');show('auth-screen');
  }
});

// -----------------------
// Auth
document.getElementById('login-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const email=document.getElementById('login-email').value.trim();
  const password=document.getElementById('login-password').value.trim();
  const { data: users } = await supabase.from('users').select('*').eq('email',email).eq('password',password);
  if(users.length>0){ currentUser=users[0]; await loadAllUsers(); showDashboard(); }
  else alert('Invalid credentials');
});

document.getElementById('register-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const firstname=document.getElementById('register-firstname').value.trim();
  const lastname=document.getElementById('register-lastname').value.trim();
  const email=document.getElementById('register-email').value.trim();
  const npn=document.getElementById('register-npn').value.trim();
  const extension=document.getElementById('register-extension').value.trim();
  const password=document.getElementById('register-password').value.trim();
  if(!firstname||!lastname||!email||!npn||!extension||!password) return alert('Complete all fields');
  const { data: existing } = await supabase.from('users').select('id').eq('email',email);
  if(existing.length>0)return alert('Email exists');
  const { data: newUser } = await supabase.from('users').insert([{ firstname, lastname, name:firstname+' '+lastname, email, password, npn, extension, is_admin:false, licenses:[], created_at:new Date().toISOString() }]).select().single();
  alert('Registered! Login now');document.getElementById('register-form').reset();
});

document.getElementById('show-register').addEventListener('click', ()=>document.getElementById('register-form').classList.toggle('hidden'));
document.getElementById('logout-btn').addEventListener('click', ()=>{currentUser=null;hide('dashboard');show('auth-screen');});

// -----------------------
// Data Loading
async function loadAllUsers(){
  const { data: users } = await supabase.from('users').select('*').order('created_at',{ascending:false});
  allUsers = users || [];
  const { data } = await supabase.from('app_settings').select('carriers').single();
  carriers = (data && data.carriers) || ["State Farm","Allstate","Geico","Progressive"];
}

// -----------------------
// Dashboard
function showDashboard(){
  hide('auth-screen');hide('loading-screen');show('dashboard');
  document.getElementById('user-name').textContent=currentUser.name;
  renderLicenses();setupTabs();
  if(currentUser.is_admin) document.getElementById('admin-tab-btn').classList.remove('hidden');
  renderAdmin();
}

// -----------------------
// Tabs
function setupTabs(){
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-panel').forEach(panel=>panel.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('bg-cyan-600'));b.classList.add('bg-gray-700');
      document.getElementById(btn.dataset.tab+'-tab')?.classList.remove('hidden');
      btn.classList.add('bg-cyan-600');
    });
  });
}

// -----------------------
// Licenses
document.getElementById('add-license-btn').addEventListener('click', ()=>{
  const statesContainer=document.getElementById('add-license-states');statesContainer.innerHTML='';
  STATES_DATA.forEach(s=>{
    const b=document.createElement('button');b.type='button';b.textContent=s.abbreviation;b.className='bubble';
    b.addEventListener('click', ()=>b.classList.toggle('selected'));statesContainer.appendChild(b);
  });
  const carriersContainer=document.getElementById('carriers-container');carriersContainer.innerHTML='';
  carriers.forEach(c=>{
    const b=document.createElement('button');b.type='button';b.textContent=c;b.className='bubble';
    b.addEventListener('click', ()=>b.classList.toggle('selected'));carriersContainer.appendChild(b);
  });
  show('add-license-modal');
});

document.getElementById('cancel-add-license').addEventListener('click', ()=>hide('add-license-modal'));

document.getElementById('add-license-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const selectedStates=[...document.querySelectorAll('#add-license-states .bubble.selected')].map(b=>b.textContent);
  const selectedCarriers=[...document.querySelectorAll('#carriers-container .bubble.selected')].map(b=>b.textContent);
  const expiration=document.getElementById('license-expiration').value;
  selectedStates.forEach(state=>{currentUser.licenses.push({ state, carriers:selectedCarriers, expiration });});
  await supabase.from('users').update({ licenses: currentUser.licenses }).eq('id', currentUser.id);
  hide('add-license-modal');renderLicenses();
});

function renderLicenses(){
  const container=document.getElementById('licenses-container');container.innerHTML='';
  currentUser.licenses.forEach((l,i)=>{
    const div=document.createElement('div');div.className='bg-gray-800 p-3 rounded mb-2';
    div.innerHTML=`<strong>${escapeHtml(l.state)}</strong> - ${l.carriers.map(c=>escapeHtml(c)).join(', ')} - Exp: ${escapeHtml(l.expiration)}
    <button class="ml-2 bg-red-600 hover:bg-red-700 px-2 py-1 rounded" onclick="deleteLicense(${i})">Delete</button>`;
    container.appendChild(div);
  });
}
window.deleteLicense=async i=>{currentUser.licenses.splice(i,1);await supabase.from('users').update({ licenses: currentUser.licenses }).eq('id', currentUser.id);renderLicenses();};

// -----------------------
// Search
document.getElementById('search-btn').addEventListener('click', ()=>{
  const q=document.getElementById('search-input').value.toLowerCase();
  const container=document.getElementById('search-results');container.innerHTML='';
  const results=allUsers.filter(u=>{
    const inName=u.name?.toLowerCase().includes(q)||false;
    const inEmail=u.email?.toLowerCase().includes(q)||false;
    const inNPN=u.npn?.toString().includes(q)||false;
    const inLicenses=(u.licenses||[]).some(l=>l.state.toLowerCase().includes(q)||(l.carriers||[]).some(c=>c.toLowerCase().includes(q)));
    return inName||inEmail||inNPN||inLicenses;
  });
  results.forEach(u=>{
    const div=document.createElement('div');div.className='bg-gray-800 p-3 rounded mb-2';
    div.innerHTML=`<strong>${escapeHtml(u.name)}</strong> - ${escapeHtml(u.email)} - NPN: ${escapeHtml(u.npn)}<br>Licenses: ${u.licenses.map(l=>l.state).join(', ')}`;
    container.appendChild(div);
  });
});

// -----------------------
// Admin
async function renderAdmin(){
  if(!currentUser.is_admin) return;
  const usersContainer=document.getElementById('users-list');usersContainer.innerHTML='';
  allUsers.forEach(u=>{
    const div=document.createElement('div');div.className='bg-gray-800 p-3 rounded mb-2';
    div.innerHTML=`<strong>${escapeHtml(u.name)}</strong> (${escapeHtml(u.email)}) - Admin: ${u.is_admin}
      <button class="ml-2 bg-red-600 hover:bg-red-700 px-2 py-1 rounded" onclick="deleteUser(${u.id})">Delete</button>`;
    usersContainer.appendChild(div);
  });
  const carriersContainer=document.getElementById('carriers-list');carriersContainer.innerHTML='';
  carriers.forEach(c=>{
    const div=document.createElement('div');div.className='flex justify-between bg-gray-700 p-2 rounded mb-1';
    div.innerHTML=`${escapeHtml(c)} <button class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded" onclick="deleteCarrier('${c}')">Delete</button>`;
    carriersContainer.appendChild(div);
  });
}

document.getElementById('add-carrier-btn').addEventListener('click', async ()=>{
  const c=document.getElementById('new-carrier-input').value.trim();if(!c)return;
  carriers.push(c);
  await supabase.from('app_settings').update({ carriers }).eq('id', 1);
  document.getElementById('new-carrier-input').value='';
  renderAdmin();
});

window.deleteCarrier=async c=>{
  carriers=carriers.filter(x=>x!==c);
  await supabase.from('app_settings').update({ carriers }).eq('id',1);
  renderAdmin();
};

window.deleteUser=async id=>{
  if(!confirm('Delete this user?'))return;
  await supabase.from('users').delete().eq('id',id);
  await loadAllUsers();renderAdmin();
};

</script>
</body>
</html>
